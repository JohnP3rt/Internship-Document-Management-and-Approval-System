<link href="/css/style-nav.css" rel="stylesheet">
<link href="/css/style-announcement.css" rel="stylesheet">

<div class="main-container d-flex">

    <div class="sidebar bg-light border-end"
        style="width: 280px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto;">
        <div class="p-3 text-center logo">
            <div class="text-center mb-3">
                <img src="/images/logo-placeholder.png" alt="Logo" style="width: 220px; height: auto;">
            </div>
        </div>
        <div class="nav flex-column nav-pills p-3">
            <a class="nav-link active" href="#home" data-bs-toggle="pill">
                <img src="/images/icons/home-icon.svg" alt="Logo" style="width: 150px; height: auto;">
                <p>Home</p>
            </a>
            <a class="nav-link" href="#documents" data-bs-toggle="pill">
                <img src="/images/icons/documents-icon.svg" alt="Logo" style="width: 150px; height: auto;">
                <p>Documents</p>
            </a>
            <a class="nav-link" href="#application" data-bs-toggle="pill">
                <img src="/images/icons/megaphone-icon.svg" alt="Logo" style="width: 150px; height: auto;">
                <p>Application</p>
            </a>
            <a class="nav-link" href="#profile" data-bs-toggle="pill">
                <img src="/images/icons/profile-icon.svg" alt="Logo" style="width: 150px; height: auto;">
                <p>Profile</p>
            </a>
        </div>

        <div class="mt-auto p-3">
            <div class="dropdown">
                <a href="#"
                    class="d-flex align-items-center text-decoration-none dropdown-toggle user-profile-link gap-3"
                    id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="user-initials-circle">
                        <%= (typeof profile !=='undefined' && profile.personalData?.givenName) ?
                            (profile.personalData.givenName.charAt(0) + (profile.personalData.surname?.charAt(0) || ''
                            )) : user.email.charAt(0).toUpperCase() %>
                    </div>
                    <span class="ms-2 fw-bold text-dark">
                        <%= (typeof profile !=='undefined' && profile.personalData?.givenName) ?
                            profile.personalData.givenName : 'User' %>
                    </span>
                </a>
                <ul class="dropdown-menu shadow" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item text-danger" href="#" onclick="handleLogout(event)">
                            <i class="bi bi-box-arrow-right me-2"></i>Log out
                        </a></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="customSuccessAlert"
        class="alert soft-alert-success shadow-sm position-fixed top-0 start-50 translate-middle-x mt-3"
        style="display: none; z-index: 10000; min-width: 300px;">
        <div class="d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2 fs-5"></i>
            <span id="successMessageText">Success!</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); min-height: 100vh;">
        <div class="container py-4">
            <div class="tab-content">

                <!-- Home/Announcements Tab -->
                <div class="tab-pane fade show active" id="home">
                    <h4 class="mb-4 section-title">Announcements</h4>

                    <!-- Replace the announcements section -->
                    <div class="announcements-list">
                        <% if (announcements && announcements.length> 0) { %>
                            <% announcements.forEach(announcement=> { %>
                                <div class="custom-post-card mb-4 px-3 py-2">
                                    <div class="card-header border-0 pt-3">
                                        <div class="d-flex align-items-center">
                                            <img src="<%= announcement.author?.profilePicture || '/images/default-avatar.png' %>"
                                                class="rounded-circle me-3" style="width: 42px; height: 42px;">
                                            <div>
                                                <div class="mb-0">
                                                    <span class="post-author-name">
                                                        <%= announcement.author?.name %>
                                                    </span>
                                                    <span class="post-author-role text-muted small">Coordinator</span>
                                                </div>
                                                <small class="text-muted" style="font-size: 0.75rem;">
                                                    <%= new Date(announcement.createdAt).toLocaleString('en-US', {
                                                        day: 'numeric' , month: 'short' , hour: 'numeric' ,
                                                        minute: '2-digit' }) %>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <%= announcement.title %>
                                        </h5>
                                        <p class="card-text">
                                            <%= announcement.content %>
                                        </p>
                                        <% if (announcement.imageUrl) { %>
                                            <div class="text-center">
                                                <img src="<%= announcement.imageUrl %>"
                                                    class="img-fluid rounded mb-3 clickable-image"
                                                    style="aspect-ratio: 1 / 1; width: 100%; max-width: 400px; object-fit: cover; cursor: pointer;"
                                                    data-bs-toggle="modal" data-bs-target="#imageModal"
                                                    onclick="prepareModal(this.src)">
                                            </div>
                                            <% } %>

                                                <!-- Comments Section -->
                                                <div class="border-top pt-3">
                                                    <button class="btn btn-outline-primary btn-sm mb-3"
                                                        onclick="toggleComments(this)">
                                                        <i class="bi bi-chat"></i> Comments (<%=
                                                            announcement.comments?.length || 0 %>)
                                                    </button>

                                                    <div class="comments-section" style="display: none;">
                                                        <form class="comment-form d-flex gap-2 mb-3"
                                                            data-announcement="<%= announcement._id %>">
                                                            <!-- use user.profilePicture OR student profile picture OR default -->
                                                            <img src="<%= user.profilePicture || (profile?.personalData?.profilePicture) || '/images/default-avatar.png' %>"
                                                                class="rounded-circle"
                                                                style="width: 32px; height: 32px; object-fit: cover;">
                                                            <div class="flex-grow-1">
                                                                <input type="text" class="form-control rounded-pill"
                                                                    placeholder="Write a comment...">
                                                            </div>
                                                            <button type="submit"
                                                                class="btn btn-primary btn-sm px-3">Post</button>
                                                        </form>

                                                        <div class="comments-list">
                                                            <% (announcement.comments || []).forEach(comment=> { %>
                                                                <div class="d-flex gap-2 mb-2">
                                                                    <img src="<%= comment.author?.profilePicture || '/images/default-avatar.png' %>"
                                                                        class="rounded-circle"
                                                                        style="width: 32px; height: 32px; object-fit: cover;">
                                                                    <div class="bg-light rounded-3 p-2 flex-grow-1">
                                                                        <div class="fw-bold">
                                                                            <%= comment.author?.name ||
                                                                                comment.author?.email %>
                                                                        </div>
                                                                        <p class="mb-1">
                                                                            <%= comment.content %>
                                                                        </p>
                                                                        <!-- server-rendered comment time -->
                                                                        <small class="text-muted">
                                                                            <%= new
                                                                                Date(comment.createdAt).toLocaleString('en-US',
                                                                                { year: 'numeric' , month: 'short' ,
                                                                                day: 'numeric' , hour: 'numeric' ,
                                                                                minute: '2-digit' }) %>
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                                <% }) %>
                                                        </div>
                                                    </div>
                                                </div>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <div class="text-center py-5 text-muted">
                                            <i class="bi bi-megaphone display-1 mb-3"></i>
                                            <p>No announcements yet.</p>
                                        </div>
                                        <% } %>
                    </div>
                </div>

                <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-xl">
                        <div class="modal-content bg-transparent border-0">
                            <div class="modal-body p-0 text-center">
                                <button type="button"
                                    class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                                    data-bs-dismiss="modal"></button>
                                <img src="" id="fullResImage" class="img-fluid rounded">
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function prepareModal(imageSrc) {
                        document.getElementById('fullResImage').src = imageSrc;
                    }
                </script>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents">
                    <h4 class="mb-4 section-title">Required Documents</h4>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Upload your documents here for review. Your coordinator will label each file as Complied if
                        approved or Needs Action if further updates are required. Use the download icons to get
                        printable templates.
                    </div>

                    <div class="accordion" id="documentsAccordion">
                        <!-- Pre-Deployment Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="preDeploymentHeader">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#preDeploymentCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Pre-Deployment Documents
                                    <% const preDeploymentCompleted=preDeploymentDocs.filter(doc=>
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                        ).length; %>
                                        <div class="ms-auto me-3">
                                            <small class="text-muted">
                                                <%= preDeploymentCompleted %>/<%= preDeploymentDocs.length %>
                                            </small>
                                        </div>
                                        <div class="progress"
                                            style="height: 10px; width: 100px; background-color: #e9ecef;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                style="width: <%= ((preDeploymentCompleted * 100) / preDeploymentDocs.length) %>%"
                                                aria-valuenow="<%= (preDeploymentCompleted / preDeploymentDocs.length * 100) %>"
                                                aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                </button>
                            </h2>
                            <div id="preDeploymentCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% preDeploymentDocs.forEach(doc=> {
                                                    const existingDoc = profile.documents.find(d => d.docType ===
                                                    doc.value);
                                                    %>
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <a href="/student/templates/<%= doc.value %>"
                                                                    class="btn btn-sm btn-link text-decoration-none"
                                                                    title="Download Template">
                                                                    <img src="/images/downloads.png" alt="Download"
                                                                        style="width: 20px; height: 20px;">
                                                                </a>
                                                                <%= doc.label %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <label class="btn btn-outline-primary btn-compact mb-0">
                                                                    <i class="bi bi-upload"></i> Upload
                                                                    <input type="file" data-doc-type="<%= doc.value %>"
                                                                        style="display: none;" class="document-upload"
                                                                        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                                </label>
                                                                <% if (existingDoc) { %>
                                                                    <a href="<%= existingDoc.fileUrl %>" target="_blank"
                                                                        class="btn btn-outline-secondary btn-compact btn-icon-only ms-2">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <% } %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                                <%= existingDoc ? existingDoc.status : 'Not Submitted'
                                                                    %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <small class="text-muted">
                                                                <%= existingDoc?.comments?.length> 0 ?
                                                                    existingDoc.comments.length + ' comment(s)' : '-' %>
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex gap-2">
                                                                <% if (existingDoc) { %>
                                                                    <a href="<%= existingDoc.fileUrl %>" target="_blank"
                                                                        class="btn btn-outline-secondary btn-compact btn-icon-only">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <% } %>
                                                                        <button
                                                                            class="btn btn-info btn-compact text-white"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#studentDocCommentsModal"
                                                                            data-doc-id="<%= existingDoc?._id %>"
                                                                            data-doc-title="<%= doc.label %>">
                                                                            <i class="bi bi-chat"></i> Comments
                                                                        </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Forms Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="legalFormsHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#legalFormsCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Legal Forms
                                    <% const legalFormsCompleted=legalForms.filter(doc=>
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                        ).length; %>
                                        <div class="ms-auto me-3">
                                            <small class="text-muted">
                                                <%= legalFormsCompleted %>/<%= legalForms.length %>
                                            </small>
                                        </div>
                                        <div class="progress"
                                            style="height: 10px; width: 100px; background-color: #e9ecef;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                style="width: <%= (preDeploymentCompleted / preDeploymentDocs.length * 100) %>%"
                                                aria-valuenow="<%= (preDeploymentCompleted / preDeploymentDocs.length * 100) %>"
                                                aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                </button>
                            </h2>
                            <div id="legalFormsCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% legalForms.forEach(doc=> {
                                                    const existingDoc = profile.documents.find(d => d.docType ===
                                                    doc.value);
                                                    %>
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <a href="/student/templates/<%= doc.value %>"
                                                                    class="btn btn-sm btn-link text-decoration-none"
                                                                    title="Download Template">
                                                                    <img src="/images/downloads.png" alt="Download"
                                                                        style="width: 20px; height: 20px;">
                                                                </a>
                                                                <%= doc.label %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <label class="btn btn-outline-primary btn-compact mb-0">
                                                                    <i class="bi bi-upload"></i> Upload
                                                                    <input type="file" data-doc-type="<%= doc.value %>"
                                                                        style="display: none;" class="document-upload"
                                                                        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                                </label>
                                                                <% if (existingDoc) { %>
                                                                    <a href="<%= existingDoc.fileUrl %>" target="_blank"
                                                                        class="btn btn-outline-secondary btn-compact btn-icon-only ms-2">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <% } %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                                <%= existingDoc ? existingDoc.status : 'Not Submitted'
                                                                    %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <small class="text-muted">
                                                                <%= existingDoc?.comments?.length> 0 ?
                                                                    existingDoc.comments.length + ' comment(s)' : '-' %>
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex gap-2">
                                                                <% if (existingDoc) { %>
                                                                    <a href="<%= existingDoc.fileUrl %>" target="_blank"
                                                                        class="btn btn-outline-secondary btn-compact btn-icon-only">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <% } %>
                                                                        <button
                                                                            class="btn btn-info btn-compact text-white"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#studentDocCommentsModal"
                                                                            data-doc-id="<%= existingDoc?._id %>"
                                                                            data-doc-title="<%= doc.label %>">
                                                                            <i class="bi bi-chat"></i> Comments
                                                                        </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Post-OJT Requirements Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="postOjtHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#postOjtCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Post-OJT Requirements
                                    <% const postOjtCompleted=postOjtDocs.filter(doc=>
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                        ).length; %>
                                        <div class="ms-auto me-3">
                                            <small class="text-muted">
                                                <%= postOjtCompleted %>/<%= postOjtDocs.length %>
                                            </small>
                                        </div>
                                        <div class="progress"
                                            style="height: 10px; width: 100px; background-color: #e9ecef;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                style="width: <%= (preDeploymentCompleted / preDeploymentDocs.length * 100) %>%"
                                                aria-valuenow="<%= (preDeploymentCompleted / preDeploymentDocs.length * 100) %>"
                                                aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                </button>
                            </h2>
                            <div id="postOjtCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% postOjtDocs.forEach(doc=> {
                                                    const existingDoc = profile.documents.find(d => d.docType ===
                                                    doc.value);
                                                    %>
                                                    <tr>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <a href="/student/templates/<%= doc.value %>"
                                                                    class="btn btn-sm btn-link text-decoration-none"
                                                                    title="Download Template">
                                                                    <img src="/images/downloads.png" alt="Download"
                                                                        style="width: 20px; height: 20px;">
                                                                </a>
                                                                <%= doc.label %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <label class="btn btn-outline-primary btn-compact mb-0">
                                                                    <i class="bi bi-upload"></i> Upload
                                                                    <input type="file" data-doc-type="<%= doc.value %>"
                                                                        style="display: none;" class="document-upload"
                                                                        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                                </label>
                                                                <% if (existingDoc) { %>
                                                                    <a href="<%= existingDoc.fileUrl %>" target="_blank"
                                                                        class="btn btn-outline-secondary btn-compact btn-icon-only ms-2">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <% } %>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                                <%= existingDoc ? existingDoc.status : 'Not Submitted'
                                                                    %>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <small class="text-muted">
                                                                <%= existingDoc?.comments?.length> 0 ?
                                                                    existingDoc.comments.length + ' comment(s)' : '-' %>
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex gap-2">
                                                                <% if (existingDoc) { %>
                                                                    <a href="<%= existingDoc.fileUrl %>" target="_blank"
                                                                        class="btn btn-outline-secondary btn-compact btn-icon-only">
                                                                        <i class="bi bi-eye"></i>
                                                                    </a>
                                                                    <% } %>
                                                                        <button
                                                                            class="btn btn-info btn-compact text-white"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#studentDocCommentsModal"
                                                                            data-doc-id="<%= existingDoc?._id %>"
                                                                            data-doc-title="<%= doc.label %>">
                                                                            <i class="bi bi-chat"></i> Comments
                                                                        </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Tab -->
                <div class="tab-pane fade" id="application">
                    <h4 class="mb-4 section-title">Internship Partnership <br>Application</h4>

                    <div class="row justify-content-center">
                        <div class="col-md-8 col-lg-6">
                            <div class="application-card mt-3">

                                <% if (profile.partnership && profile.partnership.appliedAt) { %>
                                    <div class="alert soft-alert-success d-flex align-items-center mb-4">
                                        <i class="bi bi-check-circle-fill me-3 fs-4"></i>
                                        <div>
                                            <div class="fw-bold">Application Submitted</div>
                                            <small>Applied on: <%= new
                                                    Date(profile.partnership.appliedAt).toLocaleDateString('en-US', {
                                                    year: 'numeric' , month: 'long' , day: 'numeric' }) %></small>
                                        </div>
                                    </div>
                                    <% } %>

                                        <form id="partnershipForm">
                                            <div class="mb-4">
                                                <label class="form-label">Select
                                                    Partnership/Agency</label>
                                                <select name="agency" class="form-select" id="agencySelect" required>
                                                    <option value="">Choose a partnership...</option>
                                                    <option value="B&M Fiber-Tech Fiber Optics Installation">B&M
                                                        Fiber-Tech Fiber Optics Installation</option>
                                                    <option value="Bureau of Internal Revenue-CAR">Bureau of Internal
                                                        Revenue-CAR</option>
                                                    <option value="DedEd Schools Division Office of Urdaneta City">DedEd
                                                        Schools Division Office of Urdaneta City</option>
                                                    <option value="Department of Agrarian Reform">Department of Agrarian
                                                        Reform</option>
                                                    <option
                                                        value="Department of Environment and Natural Resources-CENRO Baguio City">
                                                        Department of Environment and Natural Resources-CENRO Baguio
                                                        City</option>
                                                    <option
                                                        value="Department of Information and Communication Technology-Pangasinan">
                                                        Department of Information and Communication
                                                        Technology-Pangasinan</option>
                                                    <option value="Local Government Unit Of Manaoag">Local Government
                                                        Unit Of Manaoag</option>
                                                    <option value="Local Government Unit Of Sual">Local Government Unit
                                                        Of Sual</option>
                                                    <option value="Makerspace Innovhub">Makerspace Innovhub</option>
                                                    <option value="National Irrigation Administration PIMO">National
                                                        Irrigation Administration PIMO</option>
                                                    <option value="Offshore Concept BPO Services, Inc. (FullSuite)">
                                                        Offshore Concept BPO Services, Inc. (FullSuite)</option>
                                                    <option value="PruLife UK - Urdaneta Branch">PruLife UK - Urdaneta
                                                        Branch</option>
                                                    <option
                                                        value="PSU-Information and Communication Technology Management Office (Main)">
                                                        PSU-Information and Communication Technology Management Office
                                                        (Main)</option>
                                                    <option value="Villasis Water District">Villasis Water District
                                                    </option>
                                                    <option value="Others">Others</option>
                                                </select>
                                            </div>

                                            <div class="mb-4" id="customAgencyDiv" style="display: none;">
                                                <label class="form-label">Partnership/Agency Name</label>
                                                <input type="text" name="customAgency" class="form-control"
                                                    placeholder="Enter name...">
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label">Location</label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-white border-end-0"><i
                                                            class="bi bi-geo-alt text-muted"></i></span>
                                                    <input type="text" name="location"
                                                        class="form-control border-start-0"
                                                        placeholder="Address of the agency" required>
                                                </div>
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label">Partnership Email
                                                    (Optional)</label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-white border-end-0"><i
                                                            class="bi bi-envelope text-muted"></i></span>
                                                    <input type="email" name="email" class="form-control border-start-0"
                                                        placeholder="agency@email.com">
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-end gap-2 pt-2">
                                                <button type="reset" class="btn btn-light border px-4">Clear</button>
                                                <button type="submit" class="btn btn-primary px-4">Submit
                                                    Application</button>
                                            </div>
                                        </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-pane fade" id="profile">
                    <div class="profile-card bg-white rounded-5 mb-4">
                        <div class="d-flex justify-content-between">
                            <div class="profile-info flex-grow-1">
                                <h1 class="display-5 fw-bold mb-1">
                                    <%= profile.personalData.givenName %>
                                        <%= profile.personalData.surname %>
                                </h1>
                                <p class="text-muted mb-2">
                                    <i class="bi bi-person-badge me-2"></i>
                                    Student ID: <%= profile.personalData.studentId %>
                                </p>
                                <div class="mb-3">
                                    <p class="mb-1 fs-5">
                                        <i class="bi bi-book me-2"></i>
                                        <%= profile.personalData.course %>
                                            (<%= profile.personalData.yearSection %>)
                                    </p>
                                    <% if (profile.personalData.major) { %>
                                        <p class="text-muted mb-1">
                                            <i class="bi bi-bookmark-star me-2"></i>
                                            Major in <%= profile.personalData.major %>
                                        </p>
                                        <% } %>
                                </div>
                                <div class="contact-info mb-4">
                                    <p class="mb-1">
                                        <i class="bi bi-telephone me-2"></i>
                                        <%= profile.personalData.contactNumber %>
                                    </p>
                                    <p class="mb-1">
                                        <i class="bi bi-envelope me-2"></i>
                                        <%= user.email %>
                                    </p>
                                </div>
                                <a href="/student/edit-profile" class="btn btn-primary">
                                    <i class="bi bi-pencil-square me-2"></i>
                                    Edit Profile
                                </a>
                            </div>

                            <div class="profile-picture-container text-center ms-4">
                                <div class="position-relative" style="width: 200px; height: 200px">
                                    <img src="<%= profile.personalData.profilePicture || '/images/default-avatar.png' %>"
                                        class="rounded-circle border shadow-sm"
                                        style="width: 100%; height: 100%; object-fit: cover" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-12">
                            <div class="custom-rounded-card shadow-sm h-100">
                                <div class="card-header border-0">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-person-vcard-fill me-2"></i>
                                        Personal & Address Information
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="text-muted small">Birthday</label>
                                                <p class="mb-0">
                                                    <%= profile.personalData.dateOfBirth ? new
                                                        Date(profile.personalData.dateOfBirth).toLocaleDateString('en-US',
                                                        { year: 'numeric' , month: 'long' , day: 'numeric' })
                                                        : 'Not set' %>
                                                </p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Civil Status</label>
                                                <p class="mb-0">
                                                    <%= profile.personalData.civilStatus || 'Not set' %>
                                                </p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Gender</label>
                                                <p class="mb-0">
                                                    <%= profile.personalData.sex || 'Not set' %>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="text-muted small">Home Address</label>
                                                <p class="mb-0">
                                                    <%= profile.personalData.homeAddress || 'Not set' %>
                                                </p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Current Address</label>
                                                <p class="mb-0">
                                                    <%= profile.personalData.currentAddress || 'Not set' %>
                                                </p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="text-muted small">Parent/Guardian</label>
                                                <p class="mb-0">
                                                    <%= profile.personalData.guardianName || 'Not set' %>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <% if (profile.partnership && profile.partnership.agency) { %>
                            <div class="col-12">
                                <div class="custom-rounded-card shadow-sm h-100">
                                    <div class="card-header border-0">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-briefcase me-2"></i>
                                            Internship Partnership Application
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="text-muted small">Partnership/Agency</label>
                                                    <p class="mb-0"><strong>
                                                            <%= profile.partnership.agency %>
                                                        </strong></p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="text-muted small">Location</label>
                                                    <p class="mb-0"><strong>
                                                            <%= profile.partnership.location %>
                                                        </strong></p>
                                                </div>
                                            </div>
                                        </div>
                                        <% if (profile.partnership.email) { %>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="text-muted small">Partnership Email</label>
                                                        <p class="mb-0">
                                                            <a href="mailto:<%= profile.partnership.email %>">
                                                                <%= profile.partnership.email %>
                                                            </a>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <label class="text-muted small">Applied On</label>
                                                        <p class="mb-0">
                                                            <%= new
                                                                Date(profile.partnership.appliedAt).toLocaleDateString('en-US',
                                                                { year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                                                        </p>
                                                    </div>
                                                </div>
                                                <button onclick="switchToApplicationTab()" class="btn btn-primary mt-3">
                                                    <i class="bi bi-pencil-square me-2"></i> Edit Application
                                                </button>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Document Comments Modal -->
        <div class="modal fade" id="studentDocCommentsModal" tabindex="-1" aria-labelledby="studentDocModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDocModalLabel">Comments - <span id="studentDocTitle"></span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="studentCommentsList" class="mb-4" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.getElementById('studentDocCommentsModal').addEventListener('show.bs.modal', async function (e) {
                const button = e.relatedTarget;
                const docId = button.getAttribute('data-doc-id');
                const docTitle = button.getAttribute('data-doc-title');

                document.getElementById('studentDocTitle').textContent = docTitle;
                const commentsList = document.getElementById('studentCommentsList');

                try {
                    // Fetch fresh comments from server
                    const response = await fetch(`/student/document-comments/${docId}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch comments');
                    }

                    const data = await response.json();
                    const comments = data.comments || [];

                    if (comments.length === 0) {
                        commentsList.innerHTML = '<p class="text-muted text-center">No comments yet.</p>';
                    } else {
                        commentsList.innerHTML = comments.map(c => `
                        <div class="bg-light rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>${c.author}</strong>
                                <small class="text-muted">${new Date(c.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                            </div>
                            <p class="mb-0 mt-2">${c.content}</p>
                        </div>
                    `).join('');
                    }
                } catch (err) {
                    console.error('Error fetching comments:', err);
                    commentsList.innerHTML = '<p class="text-danger text-center">Error loading comments. Please try again.</p>';
                }
            });
        </script>
    </div>
</div>

<% if (typeof profile==='undefined' || !profile) { %>
    <div class="alert alert-danger">
        Error: Student profile not found. Please contact an administrator.
    </div>
    <% } else { %>
        <!-- ...existing profile display code... -->
        <% } %>

            <script>
                document.querySelectorAll('.document-upload').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        try {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('docType', e.target.dataset.docType);

                            const response = await fetch('/student/upload', {
                                method: 'POST',
                                body: formData
                            });

                            const result = await response.json();

                            if (!response.ok) {
                                throw new Error(result.error || 'Upload failed');
                            }

                            console.log('Upload successful:', result);
                            window.location.reload();
                        } catch (err) {
                            console.error('Upload error:', err);
                            alert(err.message || 'Upload failed. Please try again.');
                        }
                    });
                });

                function toggleComments(btn) {
                    const commentsSection = btn.nextElementSibling;
                    if (commentsSection.style.display === 'none') {
                        commentsSection.style.display = 'block';
                        btn.classList.add('active');
                    } else {
                        commentsSection.style.display = 'none';
                        btn.classList.remove('active');
                    }
                }

                document.querySelectorAll('.comment-form').forEach(form => {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const input = form.querySelector('input');
                        const announcementId = form.dataset.announcement;

                        if (!input.value.trim()) return;

                        try {
                            const response = await fetch(`/student/announcement/${announcementId}/comment`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ content: input.value.trim() })
                            });

                            if (!response.ok) throw new Error('Failed to post comment');

                            const comment = await response.json();

                            // Add new comment to DOM
                            const commentsList = form.nextElementSibling;
                            const commentHtml = `
                <div class="d-flex gap-2 mb-2">
                    <img src="${comment.author.profilePicture || '/images/default-avatar.png'}" 
                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                    <div class="bg-light rounded-3 p-2 flex-grow-1">
                        <div class="fw-bold">${comment.author.name || comment.author.email}</div>
                        <p class="mb-1">${comment.content}</p>
                        <small class="text-muted">${new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                    </div>
                </div>
            `;
                            commentsList.insertAdjacentHTML('afterbegin', commentHtml);

                            const commentBtn = form.closest('.comments-section').previousElementSibling;
                            const currentCount = parseInt(commentBtn.textContent.match(/\d+/)[0]);
                            commentBtn.innerHTML = `<i class="bi bi-chat"></i> Comments (${currentCount + 1})`;

                            input.value = '';
                        } catch (err) {
                            alert('Error posting comment: ' + err.message);
                        }
                    });
                });

                document.getElementById('agencySelect').addEventListener('change', function (e) {
                    const customAgencyDiv = document.getElementById('customAgencyDiv');
                    if (e.target.value === 'Others') {
                        customAgencyDiv.style.display = 'block';
                        customAgencyDiv.querySelector('input').setAttribute('required', 'required');
                    } else {
                        customAgencyDiv.style.display = 'none';
                        customAgencyDiv.querySelector('input').removeAttribute('required');
                    }
                });

                document.getElementById('partnershipForm').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const agencySelect = document.getElementById('agencySelect');
                    if (!agencySelect.value) {
                        alert('Please select a partnership');
                        return;
                    }

                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData);

                    if (data.agency === 'Others' && !data.customAgency) {
                        alert('Please enter a partnership name');
                        return;
                    }

                    try {
                        const response = await fetch('/student/apply-partnership', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to submit application');
                        }

                        const alertBox = document.getElementById('customSuccessAlert');
                        document.getElementById('successMessageText').innerText = 'Application submitted successfully!';
                        alertBox.style.display = 'block';

                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        window.location.reload();
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                });

                document.addEventListener('DOMContentLoaded', function () {
                    const agencySelect = document.getElementById('agencySelect');
                    if (agencySelect && agencySelect.value === 'Others') {
                        document.getElementById('customAgencyDiv').style.display = 'block';
                    }
                });
            </script>
            <div class="chatbot-launcher">
                <div class="launcher-bubble" id="launcherBubble">
                    <div class="bubble-text">
                        <strong>Need help?</strong><br>
                        Ask us a question below! 
                    </div>
                    <button class="bubble-close" onclick="closeBubble(event)">
                        <i class="bi bi-x"></i>
                    </button>
                </div>

                <button class="chatbot-toggle-btn" id="chatbotToggleBtn" onclick="toggleChatbot()"
                    title="Open Assistant">
                    <img src="/images/chatbot-mascot.png" alt="Assistant" class="chatbot-mascot-img">
                </button>
            </div>

            <div class="chatbot-widget" id="chatbotWidget">

                <div class="chatbot-view" id="homeView">
                    <div class="home-header">
                        <button class="close-btn-top" onclick="toggleChatbot()" title="Close">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <div class="home-header-content">
                            <h1>Hello! </h1>
                            <p>How can we help you?</p>
                        </div>
                    </div>

                    <div class="home-body">
                        <div class="status-card">
                            <div class="status-indicator"></div>
                            <div class="status-info">
                                <strong>System Status</strong>
                                <span>Operational</span>
                            </div>
                        </div>

                        <div class="home-search-area">
                            <button class="send-message-btn"
                                onclick="handleHomeChat({ preventDefault: () => {}, target: { value: 'I have a question' } })">
                                <i class="bi bi-chat-left-text"></i>
                                Send us a message
                            </button>
                        </div>

                        <div class="faq-section">
                            <h3>Quick Questions</h3>
                            <div class="faq-list">
                                <button class="faq-item" onclick="triggerFaq('How do I upload documents?')">
                                    <span>How to Upload Documents</span>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                                <button class="faq-item" onclick="triggerFaq('What documents are required?')">
                                    <span>Required Documents</span>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                                <button class="faq-item" onclick="triggerFaq('What does each status mean?')">
                                    <span>Document Status Guide</span>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                                <button class="faq-item" onclick="triggerFaq('Process for new company application')">
                                    <span>Process for New Company Application</span>
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chatbot-view hidden" id="chatView">
                    <div class="chat-header-simple">
                        <button class="back-btn" onclick="switchToHome()" title="Back">
                            <img src="/images/arrow.png" alt="Back" class="btn-icon">
                        </button>
                        <span class="chat-title">OJT Assistant</span>
                        <button class="close-btn-chat" onclick="toggleChatbot()" title="Close">
                            <img src="/images/close.png" alt="Close" class="btn-icon">
                        </button>
                    </div>

                    <div class="chatbot-messages" id="chatbotMessages">
                        <div class="chatbot-message bot-message">
                            <div class="message-content">
                                <p>Hello!  I'm your OJT Assistant. What can I help you with?</p>
                            </div>
                        </div>
                    </div>

                    <div class="chatbot-input-area">
                        <form id="chatbotForm" class="chatbot-form">
                            <input type="text" id="chatbotInput" placeholder="Type your question..."
                                class="chatbot-input" autocomplete="off">
                            <button type="submit" class="chatbot-send-btn">
                                <img src="/images/send.png" alt="Send" class="send-icon">
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="chatbot-overlay" id="chatbotOverlay"></div>


            <script>
                function toggleChatbot() {
                    const widget = document.getElementById('chatbotWidget');
                    const toggleBtn = document.getElementById('chatbotToggleBtn');
                    const bubble = document.getElementById('launcherBubble');
                    const overlay = document.getElementById('chatbotOverlay');

                    widget.classList.toggle('active');

                    if (widget.classList.contains('active')) {
                        toggleBtn.classList.add('hidden');
                        if (bubble) bubble.style.display = 'none';
                        overlay.classList.add('active');
                        switchToHome();
                    } else {
                        toggleBtn.classList.remove('hidden');
                        if (bubble) bubble.style.display = 'flex';
                        overlay.classList.remove('active');
                    }
                }

                function closeBubble(e) {
                    e.stopPropagation();
                    document.getElementById('launcherBubble').remove();
                }

                function switchToChat() {
                    document.getElementById('homeView').classList.add('hidden');
                    document.getElementById('chatView').classList.remove('hidden');
                    setTimeout(() => { document.getElementById('chatbotInput').focus(); }, 100);
                }

                function switchToHome() {
                    document.getElementById('chatView').classList.add('hidden');
                    document.getElementById('homeView').classList.remove('hidden');
                }

                function handleHomeChat(e) {
                    e.preventDefault();
                    switchToChat();
                    processMessage('Hello! I have a question.');
                }

                function triggerFaq(question) {
                    switchToChat();
                    processMessage(question);
                }

                async function processMessage(messageText) {
                    const messagesContainer = document.getElementById('chatbotMessages');

                    const userMsgDiv = document.createElement('div');
                    userMsgDiv.className = 'chatbot-message user-message';
                    userMsgDiv.innerHTML = `<div class="message-content">${escapeHtml(messageText)}</div>`;
                    messagesContainer.appendChild(userMsgDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'chatbot-message bot-message';
                    loadingDiv.id = 'loading-message';
                    loadingDiv.innerHTML = `<div class="message-content">...</div>`;
                    messagesContainer.appendChild(loadingDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    try {
                        const response = await fetch('/student/chatbot', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: messageText })
                        });

                        if (!response.ok) throw new Error('API Error');

                        const data = await response.json();

                        const loadingEl = document.getElementById('loading-message');
                        if (loadingEl) loadingEl.remove();

                        const botMsgDiv = document.createElement('div');
                        botMsgDiv.className = 'chatbot-message bot-message';
                        const botText = data.response || "I didn't quite get that.";
                        botMsgDiv.innerHTML = `<div class="message-content">${escapeHtml(botText)}</div>`;
                        messagesContainer.appendChild(botMsgDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } catch (err) {
                        const loadingEl = document.getElementById('loading-message');
                        if (loadingEl) loadingEl.remove();

                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'chatbot-message bot-message';
                        errorDiv.innerHTML = `<div class="message-content">Connection error. Please try again.</div>`;
                        messagesContainer.appendChild(errorDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        console.error(err);
                    }
                }

                document.getElementById('chatbotForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('chatbotInput');
                    const message = input.value.trim();
                    if (!message) return;

                    processMessage(message);
                    input.value = '';
                });

                document.getElementById('chatbotOverlay').addEventListener('click', toggleChatbot);

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('chatbotWidget').classList.contains('active')) {
                        toggleChatbot();
                    }
                });

                function escapeHtml(text) {
                    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                    return text.replace(/[&<>"']/g, m => map[m]);
                }

                function switchToApplicationTab() {
                    const appLink = document.querySelector('.nav-link[href="#application"]');

                    if (appLink) {
                        const tab = new bootstrap.Tab(appLink);
                        tab.show();

                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            </script>