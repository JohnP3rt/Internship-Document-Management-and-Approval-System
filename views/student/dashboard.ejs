<div class="d-flex">
    <!-- Left Navigation - Fixed Position -->
    <div class="sidebar bg-light border-end" style="width: 280px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto;">
        <div class="p-3 border-bottom text-center">
            <div class="text-center mb-3">
                <!-- Replace profile section with logo -->
                <img src="/images/logo-placeholder.png" alt="Logo" style="width: 150px; height: auto;">
            </div>
        </div>
        <div class="nav flex-column nav-pills p-3" style="display: flex; flex-direction: column; align-items: center;">
            <a class="nav-link active" href="#home" data-bs-toggle="pill" style="width: 100%; text-align: center;">
                <i class="bi bi-house-door"></i> Home
            </a>
            <a class="nav-link" href="#documents" data-bs-toggle="pill" style="width: 100%; text-align: center;">
                <i class="bi bi-file-earmark-text"></i> Documents
            </a>
            <a class="nav-link" href="#profile" data-bs-toggle="pill" style="width: 100%; text-align: center;">
                <i class="bi bi-person"></i> Profile
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); min-height: 100vh;">
        <div class="container py-4">
            <div class="tab-content">
                <!-- Home/Announcements Tab -->
                <div class="tab-pane fade show active" id="home">
                    <h4 class="mb-4">Announcements</h4>
                    <!-- Replace the announcements section -->
                    <div class="announcements-list">
                      <% if (announcements && announcements.length > 0) { %>
                        <% announcements.forEach(announcement => { %>
                          <div class="card mb-4">
                            <div class="card-header bg-white border-0 py-3">
                              <div class="d-flex align-items-center">
                                <img src="<%= announcement.author?.profilePicture || '/images/default-avatar.png' %>" 
                                     class="rounded-circle me-3" 
                                     style="width: 48px; height: 48px; object-fit: cover;">
                                <div>
                                  <h6 class="mb-0"><%= announcement.author?.name || announcement.author?.email %></h6>
                                  <!-- server-rendered announcement header time -->
                                  <small class="text-muted">
                                    <%= new Date(announcement.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) %>
                                  </small>
                                </div>
                              </div>
                            </div>
                            <div class="card-body pt-0">
                              <h5 class="card-title"><%= announcement.title %></h5>
                              <p class="card-text"><%= announcement.content %></p>
                              <% if (announcement.imageUrl) { %>
                                <img src="<%= announcement.imageUrl %>" class="img-fluid rounded mb-3">
                              <% } %>
                              
                              <!-- Comments Section -->
                              <div class="border-top pt-3">
                                <button class="btn btn-outline-primary btn-sm mb-3" onclick="toggleComments(this)">
                                  <i class="bi bi-chat"></i> Comments (<%= announcement.comments?.length || 0 %>)
                                </button>
                                
                                <div class="comments-section" style="display: none;">
                                  <form class="comment-form d-flex gap-2 mb-3" data-announcement="<%= announcement._id %>">
                                    <!-- use user.profilePicture OR student profile picture OR default -->
                                    <img src="<%= user.profilePicture || (profile?.personalData?.profilePicture) || '/images/default-avatar.png' %>" 
                                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                      <input type="text" class="form-control rounded-pill" placeholder="Write a comment...">
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm px-3">Post</button>
                                  </form>
                                  
                                  <div class="comments-list">
                                    <% (announcement.comments || []).forEach(comment => { %>
                                        <div class="d-flex gap-2 mb-2">
                                            <img src="<%= comment.author?.profilePicture || '/images/default-avatar.png' %>" 
                                                 class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                            <div class="bg-light rounded-3 p-2 flex-grow-1">
                                                <div class="fw-bold"><%= comment.author?.name || comment.author?.email %></div>
                                                <p class="mb-1"><%= comment.content %></p>
                                                <!-- server-rendered comment time -->
                                                <small class="text-muted">
                                                  <%= new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) %>
                                                </small>
                                            </div>
                                        </div>
                                    <% }) %>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% }) %>
                      <% } else { %>
                        <div class="text-center py-5 text-muted">
                          <i class="bi bi-megaphone display-1 mb-3"></i>
                          <p>No announcements yet.</p>
                        </div>
                      <% } %>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents">
                    <h4 class="mb-4">Required Documents</h4>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Upload your documents here for review. Your coordinator will label each file as Complied if approved or Needs Action if further updates are required. Use the download icons to get printable templates.
                    </div>
                    
                    <div class="accordion" id="documentsAccordion">
                        <!-- Pre-Deployment Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="preDeploymentHeader">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#preDeploymentCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Pre-Deployment Documents
                                    <% const preDeploymentCompleted = preDeploymentDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= preDeploymentCompleted %>/<%= preDeploymentDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (preDeploymentCompleted/preDeploymentDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="preDeploymentCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% preDeploymentDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments?.length > 0 ? existingDoc.comments.length + ' comment(s)' : '-' %></small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#studentDocCommentsModal" data-doc-id="<%= existingDoc?._id %>" data-doc-title="<%= doc.label %>">
                                                                <i class="bi bi-chat"></i> Comments
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Forms Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="legalFormsHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#legalFormsCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Legal Forms
                                    <% const legalFormsCompleted = legalForms.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= legalFormsCompleted %>/<%= legalForms.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (legalFormsCompleted/legalForms.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="legalFormsCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% legalForms.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments?.length > 0 ? existingDoc.comments.length + ' comment(s)' : '-' %></small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#studentDocCommentsModal" data-doc-id="<%= existingDoc?._id %>" data-doc-title="<%= doc.label %>">
                                                                <i class="bi bi-chat"></i> Comments
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Post-OJT Requirements Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="postOjtHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#postOjtCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Post-OJT Requirements
                                    <% const postOjtCompleted = postOjtDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= postOjtCompleted %>/<%= postOjtDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (postOjtCompleted/postOjtDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="postOjtCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% postOjtDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments?.length > 0 ? existingDoc.comments.length + ' comment(s)' : '-' %></small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#studentDocCommentsModal" data-doc-id="<%= existingDoc?._id %>" data-doc-title="<%= doc.label %>">
                                                                <i class="bi bi-chat"></i> Comments
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-pane fade" id="profile">
  <div class="profile-card bg-white rounded-lg shadow-sm p-4 mb-4">
    <div class="d-flex justify-content-between">
      <div class="profile-info flex-grow-1">
        <h1 class="display-5 fw-bold mb-1">
          <%= profile.personalData.givenName %> <%= profile.personalData.surname %>
        </h1>
        <p class="text-muted mb-2">
          <i class="bi bi-person-badge me-2"></i>
          Student ID: <%= profile.personalData.studentId %>
        </p>
        <div class="mb-3">
          <p class="mb-1 fs-5">
            <i class="bi bi-book me-2"></i>
            <%= profile.personalData.course %>
            (<%= profile.personalData.yearSection %>)
          </p>
          <% if (profile.personalData.major) { %>
          <p class="text-muted mb-1">
            <i class="bi bi-bookmark-star me-2"></i>
            Major in <%= profile.personalData.major %>
          </p>
          <% } %>
        </div>
        <div class="contact-info mb-4">
          <p class="mb-1">
            <i class="bi bi-telephone me-2"></i>
            <%= profile.personalData.contactNumber %>
          </p>
          <p class="mb-1">
            <i class="bi bi-envelope me-2"></i>
            <%= user.email %>
          </p>
        </div>
        <a href="/student/edit-profile" class="btn btn-primary">
          <i class="bi bi-pencil-square me-2"></i>
          Edit Profile
        </a>
      </div>

      <div class="profile-picture-container text-center ms-4">
        <div class="position-relative" style="width: 200px; height: 200px">
          <img
            src="<%= profile.personalData.profilePicture || '/images/default-avatar.png' %>"
            class="rounded-circle border shadow-sm"
            style="width: 100%; height: 100%; object-fit: cover"
          />
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="bi bi-person-vcard-fill me-2"></i>
            Personal & Address Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="text-muted small">Birthday</label>
                <p class="mb-0">
                  <%= profile.personalData.dateOfBirth ? new
                  Date(profile.personalData.dateOfBirth).toLocaleDateString('en-US', { year:
                  'numeric', month: 'long', day: 'numeric' }) : 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Civil Status</label>
                <p class="mb-0">
                  <%= profile.personalData.civilStatus || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Gender</label>
                <p class="mb-0">
                  <%= profile.personalData.sex || 'Not set' %>
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="text-muted small">Home Address</label>
                <p class="mb-0">
                  <%= profile.personalData.homeAddress || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Current Address</label>
                <p class="mb-0">
                  <%= profile.personalData.currentAddress || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Parent/Guardian</label>
                <p class="mb-0">
                  <%= profile.personalData.guardianName || 'Not set' %>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
            </div>
        </div>

        <!-- Student Document Comments Modal -->
        <div class="modal fade" id="studentDocCommentsModal" tabindex="-1" aria-labelledby="studentDocModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDocModalLabel">Comments - <span id="studentDocTitle"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="studentCommentsList" class="mb-4" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
        document.getElementById('studentDocCommentsModal').addEventListener('show.bs.modal', async function (e) {
            const button = e.relatedTarget;
            const docId = button.getAttribute('data-doc-id');
            const docTitle = button.getAttribute('data-doc-title');
            
            document.getElementById('studentDocTitle').textContent = docTitle;
            const commentsList = document.getElementById('studentCommentsList');
            
            try {
                // Fetch fresh comments from server
                const response = await fetch(`/student/document-comments/${docId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch comments');
                }

                const data = await response.json();
                const comments = data.comments || [];
                
                if (comments.length === 0) {
                    commentsList.innerHTML = '<p class="text-muted text-center">No comments yet.</p>';
                } else {
                    commentsList.innerHTML = comments.map(c => `
                        <div class="bg-light rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>${c.author}</strong>
                                <small class="text-muted">${new Date(c.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                            </div>
                            <p class="mb-0 mt-2">${c.content}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error fetching comments:', err);
                commentsList.innerHTML = '<p class="text-danger text-center">Error loading comments. Please try again.</p>';
            }
        });
        </script>
    </div>
</div>

<% if (typeof profile === 'undefined' || !profile) { %>
  <div class="alert alert-danger">
    Error: Student profile not found. Please contact an administrator.
  </div>
<% } else { %>
  <!-- ...existing profile display code... -->
<% } %>

<script>
document.querySelectorAll('.document-upload').forEach(input => {
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('docType', e.target.dataset.docType);

            const response = await fetch('/student/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Upload failed');
            }

            console.log('Upload successful:', result);
            window.location.reload();
        } catch (err) {
            console.error('Upload error:', err);
            alert(err.message || 'Upload failed. Please try again.');
        }
    });
});

function toggleComments(btn) {
  const commentsSection = btn.nextElementSibling;
  if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    btn.classList.add('active');
  } else {
    commentsSection.style.display = 'none';
    btn.classList.remove('active');
  }
}

document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = form.querySelector('input');
        const announcementId = form.dataset.announcement;
        
        if (!input.value.trim()) return;

        try {
            const response = await fetch(`/coordinator/announcement/${announcementId}/comment`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: input.value.trim() })
            });
            
            if (!response.ok) throw new Error('Failed to post comment');
            
            const comment = await response.json();
            
            // Add new comment to DOM
            const commentsList = form.nextElementSibling;
            const commentHtml = `
                <div class="d-flex gap-2 mb-2">
                    <img src="${comment.author.profilePicture || '/images/default-avatar.png'}" 
                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                    <div class="bg-light rounded-3 p-2 flex-grow-1">
                        <div class="fw-bold">${comment.author.name || comment.author.email}</div>
                        <p class="mb-1">${comment.content}</p>
                        <small class="text-muted">${new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                    </div>
                </div>
            `;
            commentsList.insertAdjacentHTML('afterbegin', commentHtml);
            
            const commentBtn = form.closest('.comments-section').previousElementSibling;
            const currentCount = parseInt(commentBtn.textContent.match(/\d+/)[0]);
            commentBtn.innerHTML = `<i class="bi bi-chat"></i> Comments (${currentCount + 1})`;
            
            input.value = '';
        } catch (err) {
            alert('Error posting comment: ' + err.message);
        }
    });
});


</script>
<div class="chatbot-launcher">
    <div class="launcher-bubble" id="launcherBubble">
        <div class="bubble-text">
            <strong>Need help?</strong><br>
            Ask us a question below! ðŸ‘‡
        </div>
        <button class="bubble-close" onclick="closeBubble(event)">
            <i class="bi bi-x"></i>
        </button>
    </div>

    <button class="chatbot-toggle-btn" id="chatbotToggleBtn" onclick="toggleChatbot()" title="Open Assistant">
        <img src="/images/chatbot-mascot.png" alt="Assistant" class="chatbot-mascot-img">
    </button>
</div>

<div class="chatbot-widget" id="chatbotWidget">
    
    <div class="chatbot-view" id="homeView">
        <div class="home-header">
            <button class="close-btn-top" onclick="toggleChatbot()" title="Close">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="home-header-content">
                <h1>Hello! ðŸ‘‹</h1>
                <p>How can we help you?</p>
            </div>
        </div>

        <div class="home-body">
            <div class="status-card">
                <div class="status-indicator"></div>
                <div class="status-info">
                    <strong>System Status</strong>
                    <span>Operational</span>
                </div>
            </div>

            <div class="home-search-area">
                <button class="send-message-btn" onclick="handleHomeChat({ preventDefault: () => {}, target: { value: 'I have a question' } })">
                    <i class="bi bi-chat-left-text"></i>
                    Send us a message
                </button>
            </div>

            <div class="faq-section">
                <h3>Quick Questions</h3>
                <div class="faq-list">
                    <button class="faq-item" onclick="triggerFaq('How do I upload documents?')">
                        <span>How to Upload Documents</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="faq-item" onclick="triggerFaq('What documents are required?')">
                        <span>Required Documents</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="faq-item" onclick="triggerFaq('What does each status mean?')">
                        <span>Document Status Guide</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="chatbot-view hidden" id="chatView">
        <div class="chat-header-simple">
            <button class="back-btn" onclick="switchToHome()" title="Back">
                <img src="/images/arrow.png" alt="Back" class="btn-icon">
            </button>
            <span class="chat-title">OJT Assistant</span>
            <button class="close-btn-chat" onclick="toggleChatbot()" title="Close">
                <img src="/images/close.png" alt="Close" class="btn-icon">
            </button>
        </div>
        
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chatbot-message bot-message">
                <div class="message-content">
                    <p>Hello! ðŸ‘‹ I'm your OJT Assistant. What can I help you with?</p>
                </div>
            </div>
        </div>

        <div class="chatbot-input-area">
            <form id="chatbotForm" class="chatbot-form">
                <input type="text" id="chatbotInput" placeholder="Type your question..." class="chatbot-input" autocomplete="off">
                <button type="submit" class="chatbot-send-btn">
                    <img src="/images/send.png" alt="Send" class="send-icon">
                </button>
            </form>
        </div>
    </div>
</div>

<div class="chatbot-overlay" id="chatbotOverlay"></div>

<style>
:root {
    --mongo-dark: #001E2B;
    --mongo-green: #00ED64; 
    --text-primary: #001E2B;
    --text-secondary: #5C6C75;
    --bg-gray: #F9FAFB;
    --white: #ffffff;
    --border-color: #E5E7EB;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.chatbot-launcher {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 12px;
}

.launcher-bubble {
    background: var(--white);
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    display: flex;
    align-items: flex-start;
    gap: 8px;
    animation: slideIn 0.3s ease;
    max-width: 220px;
    border: 1px solid var(--border-color);
}

.bubble-text { 
    font-size: 13px; 
    color: var(--text-primary); 
    line-height: 1.5;
}

.bubble-close { 
    background: none; 
    border: none; 
    cursor: pointer; 
    color: #9CA3AF; 
    padding: 0;
    flex-shrink: 0;
    transition: color 0.2s;
}

.bubble-close:hover {
    color: var(--text-primary);
}

.chatbot-toggle-btn {
    width: 56px; 
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--mongo-green) 0%, #00D659 100%);
    border: none;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
    overflow: hidden;
}

.chatbot-mascot-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.chatbot-toggle-btn:hover { 
    transform: scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 237, 100, 0.4);
}

.chatbot-toggle-btn:active {
    transform: scale(0.95);
}

.chatbot-toggle-btn.hidden { display: none; }

.chatbot-widget {
    position: fixed;
    bottom: 90px; 
    right: 24px;
    width: 380px; 
    height: 550px;
    background: var(--white);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    display: none;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
    border: 1px solid var(--border-color);
}

.chatbot-widget.active { 
    display: flex; 
    animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
}

.chatbot-view { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    height: 100%;
    position: relative;
    overflow: hidden;
}

.chatbot-view.hidden { display: none; }

.home-header {
    background: linear-gradient(135deg, var(--mongo-dark) 0%, #003950 100%);
    color: var(--white);
    padding: 24px 20px 20px;
    position: relative;
    z-index: 1;
    flex-shrink: 0;
}

.home-header-content {
    padding-right: 30px;
}

.home-header h1 { 
    margin: 0 0 6px 0; 
    font-size: 24px; 
    font-weight: 600;
    line-height: 1.2;
}

.home-header p { 
    margin: 0; 
    opacity: 0.9; 
    font-size: 14px;
    font-weight: 400;
}

.close-btn-top {
    position: absolute; 
    top: 16px; 
    right: 16px;
    background: rgba(255, 255, 255, 0.15);
    border: none; 
    color: white; 
    cursor: pointer; 
    font-size: 18px;
    padding: 6px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    width: 28px;
    height: 28px;
}

.close-btn-top:hover { 
    background: rgba(255, 255, 255, 0.25);
}

.home-body {
    padding: 18px;
    flex: 1;
    overflow-y: auto;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: var(--bg-gray);
}

.home-body::-webkit-scrollbar {
    width: 5px;
}

.home-body::-webkit-scrollbar-thumb {
    background: #D1D5DB;
    border-radius: 10px;
}

.home-body::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF;
}

.status-card {
    background: var(--white);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: var(--shadow-sm);
    flex-shrink: 0;
    border: 1px solid var(--border-color);
}

.status-indicator {
    width: 10px; 
    height: 10px;
    background-color: var(--mongo-green);
    border-radius: 50%;
    box-shadow: 0 0 0 3px rgba(0, 237, 100, 0.2);
    flex-shrink: 0;
}

.status-info { 
    display: flex; 
    flex-direction: column;
    gap: 2px;
}

.status-info strong { 
    font-size: 13px; 
    color: var(--text-primary);
    font-weight: 600;
}

.status-info span { 
    font-size: 12px; 
    color: var(--text-secondary);
}

.home-search-area { 
    flex-shrink: 0;
}

.send-message-btn {
    width: 100%;
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
}

.send-message-btn:hover {
    background: linear-gradient(135deg, #1D4ED8 0%, #1E40AF 100%);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.send-message-btn:active {
    transform: translateY(0);
}

.send-message-btn i {
    font-size: 16px;
}

.faq-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
}

.faq-section h3 {
    font-size: 11px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
    font-weight: 600;
    flex-shrink: 0;
}

.faq-list { 
    display: flex; 
    flex-direction: column; 
    gap: 8px;
}

.faq-item {
    background: var(--white);
    border: 1px solid var(--border-color);
    padding: 12px 14px;
    border-radius: 10px;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 500;
    text-align: left;
    transition: all 0.2s;
    width: 100%;
}

.faq-item:hover {
    border-color: var(--mongo-green);
    background: #F9FAFB;
    transform: translateX(2px);
}

.faq-item i { 
    color: #D1D5DB; 
    font-size: 12px;
    flex-shrink: 0;
    transition: color 0.2s;
}

.faq-item:hover i { 
    color: var(--mongo-green); 
}

.chat-header-simple {
    background: linear-gradient(135deg, var(--mongo-dark) 0%, #003950 100%);
    color: white;
    padding: 16px;
    display: flex; 
    align-items: center; 
    gap: 12px;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
}

.chat-title {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 600;
}

.back-btn { 
    background: rgba(255, 255, 255, 0.15); 
    border: none; 
    cursor: pointer; 
    padding: 6px; 
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    border-radius: 6px;
    width: 32px;
    height: 32px;
}

.back-btn:hover { 
    background: rgba(255, 255, 255, 0.25);
}

.close-btn-chat {
    background: rgba(255, 255, 255, 0.15);
    border: none;
    cursor: pointer;
    padding: 6px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
    border-radius: 6px;
    width: 32px;
    height: 32px;
}

.close-btn-chat:hover {
    background: rgba(255, 255, 255, 0.25);
}

.btn-icon {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

.chatbot-messages {
    flex: 1; 
    overflow-y: auto; 
    padding: 18px;
    background: var(--bg-gray);
    display: flex; 
    flex-direction: column; 
    gap: 12px;
}

.chatbot-messages::-webkit-scrollbar { 
    width: 5px; 
}

.chatbot-messages::-webkit-scrollbar-thumb { 
    background: #D1D5DB; 
    border-radius: 10px; 
}

.chatbot-messages::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF;
}

.chatbot-message { 
    display: flex; 
    animation: fadeIn 0.3s ease;
    gap: 8px;
}

.message-content {
    padding: 10px 14px;
    max-width: 75%;
    font-size: 13px;
    line-height: 1.5;
    border-radius: 14px;
    word-wrap: break-word;
}

.message-content p {
    margin: 0;
}

.bot-message { 
    justify-content: flex-start;
}

.bot-message .message-content {
    background: var(--white);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
}

.user-message { 
    justify-content: flex-end;
    margin-left: auto;
}

.user-message .message-content {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    color: white;
    border: none;
    box-shadow: var(--shadow-sm);
}

.chatbot-input-area { 
    padding: 16px; 
    background: var(--white); 
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.chatbot-form { 
    display: flex; 
    gap: 8px;
}

.chatbot-input {
    flex: 1; 
    padding: 10px 14px;
    border: 1px solid var(--border-color); 
    border-radius: 20px;
    outline: none; 
    font-size: 13px;
    transition: all 0.2s;
    background: var(--bg-gray);
}

.chatbot-input:focus { 
    border-color: #2563EB;
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.chatbot-input::placeholder {
    color: #9CA3AF;
}

.chatbot-send-btn {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    width: 36px; 
    height: 36px; 
    border-radius: 50%;
    border: none; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
}

.chatbot-send-btn:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

.chatbot-send-btn:active {
    transform: scale(0.95);
}

.send-icon {
    width: 14px;
    height: 14px;
    object-fit: contain;
    filter: brightness(0) invert(1);
}

.chatbot-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(2px);
    z-index: 999;
    display: none;
    opacity: 0;
    transition: opacity 0.3s;
}

.chatbot-overlay.active {
    display: block;
    opacity: 1;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .chatbot-widget {
        width: calc(100vw - 32px);
        height: calc(100vh - 140px);
        right: 16px;
        bottom: 80px;
    }
    
    .chatbot-launcher {
        right: 16px;
        bottom: 16px;
    }
    
    .message-content {
        max-width: 85%;
    }
}

@media (max-width: 480px) {
    .chatbot-widget {
        width: calc(100vw - 24px);
        right: 12px;
        bottom: 70px;
    }
    
    .launcher-bubble {
        max-width: 180px;
    }
}
</style>

<script>
function toggleChatbot() {
    const widget = document.getElementById('chatbotWidget');
    const toggleBtn = document.getElementById('chatbotToggleBtn');
    const bubble = document.getElementById('launcherBubble');
    const overlay = document.getElementById('chatbotOverlay');
    
    widget.classList.toggle('active');
    
    if (widget.classList.contains('active')) {
        toggleBtn.classList.add('hidden');
        if(bubble) bubble.style.display = 'none';
        overlay.classList.add('active');
        switchToHome();
    } else {
        toggleBtn.classList.remove('hidden');
        if(bubble) bubble.style.display = 'flex';
        overlay.classList.remove('active');
    }
}

function closeBubble(e) {
    e.stopPropagation();
    document.getElementById('launcherBubble').remove();
}

function switchToChat() {
    document.getElementById('homeView').classList.add('hidden');
    document.getElementById('chatView').classList.remove('hidden');
    setTimeout(() => { document.getElementById('chatbotInput').focus(); }, 100);
}

function switchToHome() {
    document.getElementById('chatView').classList.add('hidden');
    document.getElementById('homeView').classList.remove('hidden');
}

function handleHomeChat(e) {
    e.preventDefault();
    switchToChat();
    processMessage('Hello! I have a question.');
}

function triggerFaq(question) {
    switchToChat();
    processMessage(question);
}

async function processMessage(messageText) {
    const messagesContainer = document.getElementById('chatbotMessages');
    
    const userMsgDiv = document.createElement('div');
    userMsgDiv.className = 'chatbot-message user-message';
    userMsgDiv.innerHTML = `<div class="message-content">${escapeHtml(messageText)}</div>`;
    messagesContainer.appendChild(userMsgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chatbot-message bot-message';
    loadingDiv.id = 'loading-message';
    loadingDiv.innerHTML = `<div class="message-content">...</div>`;
    messagesContainer.appendChild(loadingDiv);

    try {
        const response = await fetch('/student/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageText })
        });
        
        if (!response.ok) throw new Error('API Error');
        const data = await response.json();
        
        const loadingEl = document.getElementById('loading-message');
        if(loadingEl) loadingEl.remove();

        const botMsgDiv = document.createElement('div');
        botMsgDiv.className = 'chatbot-message bot-message';
        const botText = data.response || "I didn't quite get that.";
        botMsgDiv.innerHTML = `<div class="message-content">${escapeHtml(botText)}</div>`;
        messagesContainer.appendChild(botMsgDiv);

    } catch (err) {
        console.error(err);
        const loadingEl = document.getElementById('loading-message');
        if(loadingEl) loadingEl.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chatbot-message bot-message';
        errorDiv.innerHTML = `<div class="message-content">Connection error. Please try again.</div>`;
        messagesContainer.appendChild(errorDiv);
    } finally {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

document.getElementById('chatbotForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('chatbotInput');
    const message = input.value.trim();
    if (!message) return;
    input.value = '';
    processMessage(message);
});

document.getElementById('chatbotOverlay').addEventListener('click', toggleChatbot);
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('chatbotWidget').classList.contains('active')) {
        toggleChatbot();
    }
});

function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>