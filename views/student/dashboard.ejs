<div class="d-flex">
    <!-- Left Navigation - Fixed Position -->
    <div class="sidebar bg-light border-end" style="width: 280px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto;">
        <div class="p-3 border-bottom text-center">
            <div class="text-center mb-3">
                <!-- Replace profile section with logo -->
                <img src="/images/logo-placeholder.png" alt="Logo" style="width: 150px; height: auto;">
            </div>
        </div>
        <div class="nav flex-column nav-pills p-3" style="display: flex; flex-direction: column; align-items: center;">
            <a class="nav-link active" href="#home" data-bs-toggle="pill" style="width: 100%; text-align: center;">
                <i class="bi bi-house-door"></i> Home
            </a>
            <a class="nav-link" href="#documents" data-bs-toggle="pill" style="width: 100%; text-align: center;">
                <i class="bi bi-file-earmark-text"></i> Documents
            </a>
            <a class="nav-link" href="#profile" data-bs-toggle="pill" style="width: 100%; text-align: center;">
                <i class="bi bi-person"></i> Profile
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); min-height: 100vh;">
        <div class="container py-4">
            <div class="tab-content">
                <!-- Home/Announcements Tab -->
                <div class="tab-pane fade show active" id="home">
                    <h4 class="mb-4">Announcements</h4>
                    <!-- Replace the announcements section -->
                    <div class="announcements-list">
                      <% if (announcements && announcements.length > 0) { %>
                        <% announcements.forEach(announcement => { %>
                          <div class="card mb-4">
                            <div class="card-header bg-white border-0 py-3">
                              <div class="d-flex align-items-center">
                                <img src="<%= announcement.author?.profilePicture || '/images/default-avatar.png' %>" 
                                     class="rounded-circle me-3" 
                                     style="width: 48px; height: 48px; object-fit: cover;">
                                <div>
                                  <h6 class="mb-0"><%= announcement.author?.name || announcement.author?.email %></h6>
                                  <!-- server-rendered announcement header time -->
                                  <small class="text-muted">
                                    <%= new Date(announcement.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) %>
                                  </small>
                                </div>
                              </div>
                            </div>
                            <div class="card-body pt-0">
                              <h5 class="card-title"><%= announcement.title %></h5>
                              <p class="card-text"><%= announcement.content %></p>
                              <% if (announcement.imageUrl) { %>
                                <img src="<%= announcement.imageUrl %>" class="img-fluid rounded mb-3">
                              <% } %>
                              
                              <!-- Comments Section -->
                              <div class="border-top pt-3">
                                <button class="btn btn-outline-primary btn-sm mb-3" onclick="toggleComments(this)">
                                  <i class="bi bi-chat"></i> Comments (<%= announcement.comments?.length || 0 %>)
                                </button>
                                
                                <div class="comments-section" style="display: none;">
                                  <form class="comment-form d-flex gap-2 mb-3" data-announcement="<%= announcement._id %>">
                                    <!-- use user.profilePicture OR student profile picture OR default -->
                                    <img src="<%= user.profilePicture || (profile?.personalData?.profilePicture) || '/images/default-avatar.png' %>" 
                                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                      <input type="text" class="form-control rounded-pill" placeholder="Write a comment...">
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm px-3">Post</button>
                                  </form>
                                  
                                  <div class="comments-list">
                                    <% (announcement.comments || []).forEach(comment => { %>
                                        <div class="d-flex gap-2 mb-2">
                                            <img src="<%= comment.author?.profilePicture || '/images/default-avatar.png' %>" 
                                                 class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                            <div class="bg-light rounded-3 p-2 flex-grow-1">
                                                <div class="fw-bold"><%= comment.author?.name || comment.author?.email %></div>
                                                <p class="mb-1"><%= comment.content %></p>
                                                <!-- server-rendered comment time -->
                                                <small class="text-muted">
                                                  <%= new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) %>
                                                </small>
                                            </div>
                                        </div>
                                    <% }) %>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% }) %>
                      <% } else { %>
                        <div class="text-center py-5 text-muted">
                          <i class="bi bi-megaphone display-1 mb-3"></i>
                          <p>No announcements yet.</p>
                        </div>
                      <% } %>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents">
                    <h4 class="mb-4">Required Documents</h4>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Upload your documents here for review. Your coordinator will label each file as Complied if approved or Needs Action if further updates are required. Use the download icons to get printable templates.
                    </div>
                    
                    <div class="accordion" id="documentsAccordion">
                        <!-- Pre-Deployment Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="preDeploymentHeader">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#preDeploymentCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Pre-Deployment Documents
                                    <% const preDeploymentCompleted = preDeploymentDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= preDeploymentCompleted %>/<%= preDeploymentDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (preDeploymentCompleted/preDeploymentDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="preDeploymentCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% preDeploymentDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments?.length > 0 ? existingDoc.comments.length + ' comment(s)' : '-' %></small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#studentDocCommentsModal" data-doc-id="<%= existingDoc?._id %>" data-doc-title="<%= doc.label %>">
                                                                <i class="bi bi-chat"></i> Comments
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Forms Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="legalFormsHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#legalFormsCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Legal Forms
                                    <% const legalFormsCompleted = legalForms.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= legalFormsCompleted %>/<%= legalForms.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (legalFormsCompleted/legalForms.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="legalFormsCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% legalForms.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments?.length > 0 ? existingDoc.comments.length + ' comment(s)' : '-' %></small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#studentDocCommentsModal" data-doc-id="<%= existingDoc?._id %>" data-doc-title="<%= doc.label %>">
                                                                <i class="bi bi-chat"></i> Comments
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Post-OJT Requirements Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="postOjtHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#postOjtCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Post-OJT Requirements
                                    <% const postOjtCompleted = postOjtDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= postOjtCompleted %>/<%= postOjtDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (postOjtCompleted/postOjtDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="postOjtCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% postOjtDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments?.length > 0 ? existingDoc.comments.length + ' comment(s)' : '-' %></small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2">
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#studentDocCommentsModal" data-doc-id="<%= existingDoc?._id %>" data-doc-title="<%= doc.label %>">
                                                                <i class="bi bi-chat"></i> Comments
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-pane fade" id="profile">
  <div class="profile-card bg-white rounded-lg shadow-sm p-4 mb-4">
    <div class="d-flex justify-content-between">
      <div class="profile-info flex-grow-1">
        <h1 class="display-5 fw-bold mb-1">
          <%= profile.personalData.givenName %> <%= profile.personalData.surname %>
        </h1>
        <p class="text-muted mb-2">
          <i class="bi bi-person-badge me-2"></i>
          Student ID: <%= profile.personalData.studentId %>
        </p>
        <div class="mb-3">
          <p class="mb-1 fs-5">
            <i class="bi bi-book me-2"></i>
            <%= profile.personalData.course %>
            (<%= profile.personalData.yearSection %>)
          </p>
          <% if (profile.personalData.major) { %>
          <p class="text-muted mb-1">
            <i class="bi bi-bookmark-star me-2"></i>
            Major in <%= profile.personalData.major %>
          </p>
          <% } %>
        </div>
        <div class="contact-info mb-4">
          <p class="mb-1">
            <i class="bi bi-telephone me-2"></i>
            <%= profile.personalData.contactNumber %>
          </p>
          <p class="mb-1">
            <i class="bi bi-envelope me-2"></i>
            <%= user.email %>
          </p>
        </div>
        <a href="/student/edit-profile" class="btn btn-primary">
          <i class="bi bi-pencil-square me-2"></i>
          Edit Profile
        </a>
      </div>

      <div class="profile-picture-container text-center ms-4">
        <div class="position-relative" style="width: 200px; height: 200px">
          <img
            src="<%= profile.personalData.profilePicture || '/images/default-avatar.png' %>"
            class="rounded-circle border shadow-sm"
            style="width: 100%; height: 100%; object-fit: cover"
          />
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="bi bi-person-vcard-fill me-2"></i>
            Personal & Address Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="text-muted small">Birthday</label>
                <p class="mb-0">
                  <%= profile.personalData.dateOfBirth ? new
                  Date(profile.personalData.dateOfBirth).toLocaleDateString('en-US', { year:
                  'numeric', month: 'long', day: 'numeric' }) : 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Civil Status</label>
                <p class="mb-0">
                  <%= profile.personalData.civilStatus || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Gender</label>
                <p class="mb-0">
                  <%= profile.personalData.sex || 'Not set' %>
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="text-muted small">Home Address</label>
                <p class="mb-0">
                  <%= profile.personalData.homeAddress || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Current Address</label>
                <p class="mb-0">
                  <%= profile.personalData.currentAddress || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Parent/Guardian</label>
                <p class="mb-0">
                  <%= profile.personalData.guardianName || 'Not set' %>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
            </div>
        </div>

        <!-- Student Document Comments Modal -->
        <div class="modal fade" id="studentDocCommentsModal" tabindex="-1" aria-labelledby="studentDocModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentDocModalLabel">Comments - <span id="studentDocTitle"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="studentCommentsList" class="mb-4" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
        document.getElementById('studentDocCommentsModal').addEventListener('show.bs.modal', async function (e) {
            const button = e.relatedTarget;
            const docId = button.getAttribute('data-doc-id');
            const docTitle = button.getAttribute('data-doc-title');
            
            document.getElementById('studentDocTitle').textContent = docTitle;
            const commentsList = document.getElementById('studentCommentsList');
            
            try {
                // Fetch fresh comments from server
                const response = await fetch(`/student/document-comments/${docId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch comments');
                }

                const data = await response.json();
                const comments = data.comments || [];
                
                if (comments.length === 0) {
                    commentsList.innerHTML = '<p class="text-muted text-center">No comments yet.</p>';
                } else {
                    commentsList.innerHTML = comments.map(c => `
                        <div class="bg-light rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>${c.author}</strong>
                                <small class="text-muted">${new Date(c.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                            </div>
                            <p class="mb-0 mt-2">${c.content}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error fetching comments:', err);
                commentsList.innerHTML = '<p class="text-danger text-center">Error loading comments. Please try again.</p>';
            }
        });
        </script>
    </div>
</div>

<% if (typeof profile === 'undefined' || !profile) { %>
  <div class="alert alert-danger">
    Error: Student profile not found. Please contact an administrator.
  </div>
<% } else { %>
  <!-- ...existing profile display code... -->
<% } %>

<script>
document.querySelectorAll('.document-upload').forEach(input => {
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('docType', e.target.dataset.docType);

            const response = await fetch('/student/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Upload failed');
            }

            console.log('Upload successful:', result);
            window.location.reload();
        } catch (err) {
            console.error('Upload error:', err);
            alert(err.message || 'Upload failed. Please try again.');
        }
    });
});

function toggleComments(btn) {
  const commentsSection = btn.nextElementSibling;
  if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    btn.classList.add('active');
  } else {
    commentsSection.style.display = 'none';
    btn.classList.remove('active');
  }
}

document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = form.querySelector('input');
        const announcementId = form.dataset.announcement;
        
        if (!input.value.trim()) return;

        try {
            const response = await fetch(`/coordinator/announcement/${announcementId}/comment`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: input.value.trim() })
            });
            
            if (!response.ok) throw new Error('Failed to post comment');
            
            const comment = await response.json();
            
            // Add new comment to DOM
            const commentsList = form.nextElementSibling;
            const commentHtml = `
                <div class="d-flex gap-2 mb-2">
                    <img src="${comment.author.profilePicture || '/images/default-avatar.png'}" 
                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                    <div class="bg-light rounded-3 p-2 flex-grow-1">
                        <div class="fw-bold">${comment.author.name || comment.author.email}</div>
                        <p class="mb-1">${comment.content}</p>
                        <small class="text-muted">${new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                    </div>
                </div>
            `;
            commentsList.insertAdjacentHTML('afterbegin', commentHtml);
            
            const commentBtn = form.closest('.comments-section').previousElementSibling;
            const currentCount = parseInt(commentBtn.textContent.match(/\d+/)[0]);
            commentBtn.innerHTML = `<i class="bi bi-chat"></i> Comments (${currentCount + 1})`;
            
            input.value = '';
        } catch (err) {
            alert('Error posting comment: ' + err.message);
        }
    });
});
</script><div class="chatbot-launcher">
    <div class="launcher-bubble" id="launcherBubble">
        <div class="bubble-text">
            <strong>Need help?</strong><br>
            Ask us a question below! ðŸ‘‡
        </div>
        <button class="bubble-close" onclick="closeBubble(event)">
            <i class="bi bi-x"></i>
        </button>
    </div>

    <button class="chatbot-toggle-btn" id="chatbotToggleBtn" onclick="toggleChatbot()" title="Open Assistant">
        <img src="/images/chatbot-mascot.png" alt="Assistant" class="chatbot-mascot-img">
    </button>
</div>

<div class="chatbot-widget" id="chatbotWidget">
    
    <div class="chatbot-view" id="homeView">
        <div class="home-header">
            <button class="close-btn-top" onclick="toggleChatbot()" title="Close">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="home-header-content">
                <h1>Hello! ðŸ‘‹</h1>
                <p>How can we help you?</p>
            </div>
        </div>

        <div class="home-body">
            <div class="status-card">
                <div class="status-indicator"></div>
                <div class="status-info">
                    <strong>System Status</strong>
                    <span>Operational</span>
                </div>
            </div>

            <div class="home-search-area">
                <button class="send-message-btn" onclick="handleHomeChat({ preventDefault: () => {}, target: { value: 'I have a question' } })">
                    <i class="bi bi-chat-left-text"></i>
                    Send us a message
                </button>
            </div>

            <div class="faq-section">
                <h3>Quick Questions</h3>
                <div class="faq-list">
                    <button class="faq-item" onclick="triggerFaq('How do I upload documents?')">
                        <span>How to Upload Documents</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="faq-item" onclick="triggerFaq('What documents are required?')">
                        <span>Required Documents</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="faq-item" onclick="triggerFaq('What does each status mean?')">
                        <span>Document Status Guide</span>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="chatbot-view hidden" id="chatView">
        <div class="chat-header-simple">
            <button class="back-btn" onclick="switchToHome()" title="Back">
                <img src="/images/arrow.png" alt="Back" class="btn-icon">
            </button>
            <span class="chat-title">OJT Assistant</span>
            <button class="close-btn-chat" onclick="toggleChatbot()" title="Close">
                <img src="/images/close.png" alt="Close" class="btn-icon">
            </button>
        </div>
        
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chatbot-message bot-message">
               
                <div class="message-content">
                    <p>Hello! ðŸ‘‹ I'm your OJT Assistant. What can I help you with?</p>
                </div>
            </div>
        </div>

        <div class="chatbot-input-area">
            <form id="chatbotForm" class="chatbot-form">
                <input type="text" id="chatbotInput" placeholder="Type your question..." class="chatbot-input" autocomplete="off">
                <button type="submit" class="chatbot-send-btn">
                    <img src="/images/send.png" alt="Send" class="send-icon">
                </button>
            </form>
        </div>
    </div>
</div>

<div class="chatbot-overlay" id="chatbotOverlay"></div>

<style>
/* --- VARIABLES --- */
:root {
    --mongo-dark: #001E2B;
    --mongo-green: #00ED64; 
    --text-primary: #001E2B;
    --text-secondary: #5C6C75;
    --bg-gray: #F1F5F9;
    --white: #ffffff;
}

/* --- LAUNCHER --- */
.chatbot-launcher {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
}

.launcher-bubble {
    background: var(--white);
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    display: flex;
    align-items: flex-start;
    gap: 8px;
    animation: slideIn 0.3s ease;
    max-width: 200px;
}

.bubble-text { 
    font-size: 13px; 
    color: var(--text-primary); 
    line-height: 1.4;
}

.bubble-close { 
    background: none; 
    border: none; 
    cursor: pointer; 
    color: #999; 
    padding: 0;
    flex-shrink: 0;
}

.chatbot-toggle-btn {
    width: 70px; 
    height: 70px;
    border-radius: 50%;
    background: var(--mongo-green);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 237, 100, 0.4);
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    padding: 0;
    overflow: hidden;
}

.chatbot-mascot-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.chatbot-toggle-btn:hover { 
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0, 237, 100, 0.5);
}

.chatbot-toggle-btn.hidden { display: none; }

/* --- MAIN WIDGET --- */
.chatbot-widget {
    position: fixed;
    bottom: 100px; 
    right: 20px;
    width: 400px; 
    height: 680px;
    background: var(--bg-gray);
    border-radius: 16px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.25);
    display: none;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;
    font-family: 'Segoe UI', system-ui, sans-serif;
}

.chatbot-widget.active { 
    display: flex; 
    animation: slideUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
}

/* --- HOME VIEW --- */
.chatbot-view { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    height: 100%;
    position: relative;
    overflow: hidden;
}

.chatbot-view.hidden { display: none; }

.home-header {
    background: linear-gradient(135deg, var(--mongo-dark) 0%, #003344 100%);
    color: var(--white);
    padding: 28px 24px 24px;
    position: relative;
    z-index: 1;
    flex-shrink: 0;
}

.home-header-content {
    padding-right: 30px;
}

.home-header h1 { 
    margin: 0 0 8px 0; 
    font-size: 28px; 
    font-weight: 700;
    line-height: 1.2;
}

.home-header p { 
    margin: 0; 
    opacity: 0.9; 
    font-size: 15px;
    font-weight: 500;
}

.close-btn-top {
    position: absolute; 
    top: 16px; 
    right: 16px;
    background: rgba(255,255,255,0.2);
    border: none; 
    color: white; 
    opacity: 0.8;
    cursor: pointer; 
    font-size: 20px;
    padding: 4px 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn-top:hover { 
    opacity: 1;
    background: rgba(255,255,255,0.3);
}

.home-body {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
    z-index: 2;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.home-body::-webkit-scrollbar {
    width: 6px;
}

.home-body::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

/* Status Card */
.status-card {
    background: var(--white);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    flex-shrink: 0;
}

.status-indicator {
    width: 12px; 
    height: 12px;
    background-color: var(--mongo-green);
    border-radius: 50%;
    box-shadow: 0 0 0 4px rgba(0, 237, 100, 0.2);
    flex-shrink: 0;
}

.status-info { 
    display: flex; 
    flex-direction: column;
    gap: 2px;
}

.status-info strong { 
    font-size: 13px; 
    color: var(--text-primary);
    font-weight: 600;
}

.status-info span { 
    font-size: 12px; 
    color: var(--text-secondary);
}

/* Home Input Area */
.home-search-area { 
    flex-shrink: 0;
}

.send-message-btn {
    width: 100%;
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    color: white;
    border: none;
    padding: 14px 16px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
}

.send-message-btn:hover {
    background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    transform: translateY(-2px);
}

.send-message-btn:active {
    transform: translateY(0);
}

.send-message-btn i {
    font-size: 16px;
}

/* FAQ Section */
.faq-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
}

.faq-section h3 {
    font-size: 13px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
    font-weight: 600;
    flex-shrink: 0;
}

.faq-list { 
    display: flex; 
    flex-direction: column; 
    gap: 8px;
}

.faq-item {
    background: var(--white);
    border: 1px solid #e0e0e0;
    padding: 12px 14px;
    border-radius: 8px;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 500;
    text-align: left;
    transition: all 0.2s;
    width: 100%;
}

.faq-item:hover {
    border-color: var(--mongo-green);
    background: #fcfcfc;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.faq-item i { 
    color: #ccc; 
    font-size: 12px;
    flex-shrink: 0;
}

.faq-item:hover i { 
    color: var(--mongo-green); 
}

/* --- CHAT INTERFACE --- */
.chat-header-simple {
    background: linear-gradient(135deg, var(--mongo-dark) 0%, #0a3f5e 100%);
    color: white;
    padding: 16px;
    display: flex; 
    align-items: center; 
    gap: 12px;
    font-weight: 600;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.chat-title {
    flex: 1;
    text-align: center;
    font-size: 16px;
}

.back-btn { 
    background: none; 
    border: none; 
    cursor: pointer; 
    padding: 6px 8px; 
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
}

.back-btn:hover { 
    opacity: 0.7;
}

.close-btn-chat {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 8px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
}

.close-btn-chat:hover {
    opacity: 0.7;
}

.btn-icon {
    width: 18px;
    height: 18px;
    object-fit: contain;
}

.chatbot-messages {
    flex: 1; 
    overflow-y: auto; 
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex; 
    flex-direction: column; 
    gap: 16px;
}

.chatbot-messages::-webkit-scrollbar { 
    width: 6px; 
}

.chatbot-messages::-webkit-scrollbar-thumb { 
    background: #ccc; 
    border-radius: 3px; 
}

.chatbot-messages::-webkit-scrollbar-thumb:hover {
    background: #999;
}

.chatbot-message { 
    display: flex; 
    animation: fadeIn 0.2s ease;
    gap: 10px;
}

.message-avatar {
    width: 32px;
    height: 32px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-icon {
    font-size: 18px;
}

.message-content {
    padding: 12px 16px;
    max-width: 70%;
    font-size: 14px;
    line-height: 1.6;
    border-radius: 16px;
    word-wrap: break-word;
}

.bot-message { 
    justify-content: flex-start;
}

.bot-message .message-content {
    background: linear-gradient(135deg, white 0%, #f5f5f5 100%);
    color: var(--text-primary);
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.user-message { 
    justify-content: flex-end;
    margin-left: auto;
}

.user-message .message-content {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    color: white;
    border: none;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
}

.user-message .message-avatar {
    display: none;
}

.chatbot-input-area { 
    padding: 16px; 
    background: white; 
    border-top: 1px solid #e0e0e0;
    flex-shrink: 0;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
}

.chatbot-form { 
    display: flex; 
    gap: 10px;
}

.chatbot-input {
    flex: 1; 
    padding: 12px 16px;
    border: 1px solid #e0e0e0; 
    border-radius: 24px;
    outline: none; 
    font-size: 14px;
    transition: all 0.2s;
    background: #f8f9fa;
}

.chatbot-input:focus { 
    border-color: #0d6efd;
    background: white;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
}

.chatbot-input::placeholder {
    color: #999;
}

.chatbot-send-btn {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    width: 38px; 
    height: 38px; 
    border-radius: 50%;
    border: none; 
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
}

.chatbot-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.chatbot-send-btn:active {
    transform: scale(0.95);
}

.send-icon {
    width: 16px;
    height: 16px;
    object-fit: contain;
    filter: brightness(0) invert(1);
}

<!-- ...existing responsive styles... -->
</style>

<script>
// --- UI TOGGLE ---
function toggleChatbot() {
    const widget = document.getElementById('chatbotWidget');
    const toggleBtn = document.getElementById('chatbotToggleBtn');
    const bubble = document.getElementById('launcherBubble');
    const overlay = document.getElementById('chatbotOverlay');
    
    widget.classList.toggle('active');
    
    if (widget.classList.contains('active')) {
        toggleBtn.classList.add('hidden');
        if(bubble) bubble.style.display = 'none';
        overlay.classList.add('active');
        switchToHome(); // Default to home when opening
    } else {
        toggleBtn.classList.remove('hidden');
        if(bubble) bubble.style.display = 'flex';
        overlay.classList.remove('active');
    }
}

function closeBubble(e) {
    e.stopPropagation();
    document.getElementById('launcherBubble').remove();
}

// --- NAVIGATION ---
function switchToChat() {
    document.getElementById('homeView').classList.add('hidden');
    document.getElementById('chatView').classList.remove('hidden');
    setTimeout(() => { document.getElementById('chatbotInput').focus(); }, 100);
}

function switchToHome() {
    document.getElementById('chatView').classList.add('hidden');
    document.getElementById('homeView').classList.remove('hidden');
}

// --- LOGIC: HANDLE HOME INPUT (DIRECT CHAT) ---
function handleHomeChat(e) {
    e.preventDefault();
    
    // 1. Switch View
    switchToChat();
    
    // 2. Process the message in the chat view
    processMessage('Hello! I have a question.');
}

// --- LOGIC: HANDLE FAQ CLICKS ---
function triggerFaq(question) {
    // 1. Switch View
    switchToChat();
    // 2. Process the pre-defined question
    processMessage(question);
}

// --- SHARED MESSAGE PROCESSING ---
async function processMessage(messageText) {
    const messagesContainer = document.getElementById('chatbotMessages');
    
    // Add User Message UI
    const userMsgDiv = document.createElement('div');
    userMsgDiv.className = 'chatbot-message user-message';
    userMsgDiv.innerHTML = `<div class="message-content">${escapeHtml(messageText)}</div>`;
    messagesContainer.appendChild(userMsgDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Add Loading UI
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chatbot-message bot-message';
    loadingDiv.id = 'loading-message';
    loadingDiv.innerHTML = `<div class="message-content">...</div>`;
    messagesContainer.appendChild(loadingDiv);

    try {
        const response = await fetch('/student/chatbot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: messageText })
        });
        
        if (!response.ok) throw new Error('API Error');
        const data = await response.json();
        
        // Remove Loading
        const loadingEl = document.getElementById('loading-message');
        if(loadingEl) loadingEl.remove();

        // Add Bot Response UI
        const botMsgDiv = document.createElement('div');
        botMsgDiv.className = 'chatbot-message bot-message';
        const botText = data.response || "I didn't quite get that.";
        botMsgDiv.innerHTML = `<div class="message-content">${escapeHtml(botText)}</div>`;
        messagesContainer.appendChild(botMsgDiv);

    } catch (err) {
        console.error(err);
        const loadingEl = document.getElementById('loading-message');
        if(loadingEl) loadingEl.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'chatbot-message bot-message';
        errorDiv.innerHTML = `<div class="message-content">Connection error. Please try again.</div>`;
        messagesContainer.appendChild(errorDiv);
    } finally {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// --- STANDARD CHAT FORM HANDLING ---
document.getElementById('chatbotForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('chatbotInput');
    const message = input.value.trim();
    if (!message) return;
    input.value = '';
    processMessage(message);
});

// Event Listeners
document.getElementById('chatbotOverlay').addEventListener('click', toggleChatbot);
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('chatbotWidget').classList.contains('active')) {
        toggleChatbot();
    }
});

function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>