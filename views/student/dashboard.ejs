<div class="d-flex">
    <!-- Left Navigation - Fixed Position -->
    <div class="sidebar bg-light border-end" style="width: 280px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto;">
        <div class="p-3 border-bottom">
            <div class="text-center mb-3">
                <!-- Replace profile section with logo -->
                <img src="/images/logo-placeholder.png" alt="Logo" style="width: 150px; height: auto;">
            </div>
        </div>
        <div class="nav flex-column nav-pills p-3">
            <a class="nav-link active" href="#home" data-bs-toggle="pill">
                <i class="bi bi-house-door"></i> Home
            </a>
            <a class="nav-link" href="#documents" data-bs-toggle="pill">
                <i class="bi bi-file-earmark-text"></i> Documents
            </a>
            <a class="nav-link" href="#profile" data-bs-toggle="pill">
                <i class="bi bi-person"></i> Profile
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); min-height: 100vh;">
        <div class="container py-4">
            <div class="tab-content">
                <!-- Home/Announcements Tab -->
                <div class="tab-pane fade show active" id="home">
                    <h4 class="mb-4">Announcements</h4>
                    <!-- Replace the announcements section -->
                    <div class="announcements-list">
                      <% if (announcements && announcements.length > 0) { %>
                        <% announcements.forEach(announcement => { %>
                          <div class="card mb-4">
                            <div class="card-header bg-white border-0 py-3">
                              <div class="d-flex align-items-center">
                                <img src="<%= announcement.author?.profilePicture || '/images/default-avatar.png' %>" 
                                     class="rounded-circle me-3" 
                                     style="width: 48px; height: 48px; object-fit: cover;">
                                <div>
                                  <h6 class="mb-0"><%= announcement.author?.name || announcement.author?.email %></h6>
                                  <!-- server-rendered announcement header time -->
                                  <small class="text-muted">
                                    <%= new Date(announcement.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) %>
                                  </small>
                                </div>
                              </div>
                            </div>
                            <div class="card-body pt-0">
                              <h5 class="card-title"><%= announcement.title %></h5>
                              <p class="card-text"><%= announcement.content %></p>
                              <% if (announcement.imageUrl) { %>
                                <img src="<%= announcement.imageUrl %>" class="img-fluid rounded mb-3">
                              <% } %>
                              
                              <!-- Comments Section -->
                              <div class="border-top pt-3">
                                <button class="btn btn-outline-primary btn-sm mb-3" onclick="toggleComments(this)">
                                  <i class="bi bi-chat"></i> Comments (<%= announcement.comments?.length || 0 %>)
                                </button>
                                
                                <div class="comments-section" style="display: none;">
                                  <form class="comment-form d-flex gap-2 mb-3" data-announcement="<%= announcement._id %>">
                                    <!-- use user.profilePicture OR student profile picture OR default -->
                                    <img src="<%= user.profilePicture || (profile?.personalData?.profilePicture) || '/images/default-avatar.png' %>" 
                                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                      <input type="text" class="form-control rounded-pill" placeholder="Write a comment...">
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm px-3">Post</button>
                                  </form>
                                  
                                  <div class="comments-list">
                                    <% (announcement.comments || []).forEach(comment => { %>
                                        <div class="d-flex gap-2 mb-2">
                                            <img src="<%= comment.author?.profilePicture || '/images/default-avatar.png' %>" 
                                                 class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                                            <div class="bg-light rounded-3 p-2 flex-grow-1">
                                                <div class="fw-bold"><%= comment.author?.name || comment.author?.email %></div>
                                                <p class="mb-1"><%= comment.content %></p>
                                                <!-- server-rendered comment time -->
                                                <small class="text-muted">
                                                  <%= new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) %>
                                                </small>
                                            </div>
                                        </div>
                                    <% }) %>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% }) %>
                      <% } else { %>
                        <div class="text-center py-5 text-muted">
                          <i class="bi bi-megaphone display-1 mb-3"></i>
                          <p>No announcements yet.</p>
                        </div>
                      <% } %>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents">
                    <h4 class="mb-4">Required Documents</h4>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Upload your documents here for review. Your coordinator will label each file as Complied if approved or Needs Action if further updates are required. Use the download icons to get printable templates.
                    </div>
                    
                    <div class="accordion" id="documentsAccordion">
                        <!-- Pre-Deployment Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="preDeploymentHeader">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#preDeploymentCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Pre-Deployment Documents
                                    <% const preDeploymentCompleted = preDeploymentDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done') // Changed from 'Completed' to 'Done'
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= preDeploymentCompleted %>/<%= preDeploymentDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (preDeploymentCompleted/preDeploymentDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="preDeploymentCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% preDeploymentDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments || '-' %></small>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Forms Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="legalFormsHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#legalFormsCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Legal Forms
                                    <% const legalFormsCompleted = legalForms.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Completed')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= legalFormsCompleted %>/<%= legalForms.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (legalFormsCompleted/legalForms.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="legalFormsCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% legalForms.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments || '-' %></small>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Post-OJT Requirements Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="postOjtHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#postOjtCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Post-OJT Requirements
                                    <% const postOjtCompleted = postOjtDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Completed')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= postOjtCompleted %>/<%= postOjtDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (postOjtCompleted/postOjtDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="postOjtCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% postOjtDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments || '-' %></small>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-pane fade" id="profile">
  <div class="profile-card bg-white rounded-lg shadow-sm p-4 mb-4">
    <div class="d-flex justify-content-between">
      <div class="profile-info flex-grow-1">
        <h1 class="display-5 fw-bold mb-1">
          <%= profile.personalData.givenName %> <%= profile.personalData.surname %>
        </h1>
        <p class="text-muted mb-2">
          <i class="bi bi-person-badge me-2"></i>
          Student ID: <%= profile.personalData.studentId %>
        </p>
        <div class="mb-3">
          <p class="mb-1 fs-5">
            <i class="bi bi-book me-2"></i>
            <%= profile.personalData.course %>
            (<%= profile.personalData.yearSection %>)
          </p>
          <% if (profile.personalData.major) { %>
          <p class="text-muted mb-1">
            <i class="bi bi-bookmark-star me-2"></i>
            Major in <%= profile.personalData.major %>
          </p>
          <% } %>
        </div>
        <div class="contact-info mb-4">
          <p class="mb-1">
            <i class="bi bi-telephone me-2"></i>
            <%= profile.personalData.contactNumber %>
          </p>
          <p class="mb-1">
            <i class="bi bi-envelope me-2"></i>
            <%= user.email %>
          </p>
        </div>
        <a href="/student/edit-profile" class="btn btn-primary">
          <i class="bi bi-pencil-square me-2"></i>
          Edit Profile
        </a>
      </div>

      <div class="profile-picture-container text-center ms-4">
        <div class="position-relative" style="width: 200px; height: 200px">
          <img
            src="<%= profile.personalData.profilePicture || '/images/default-avatar.png' %>"
            class="rounded-circle border shadow-sm"
            style="width: 100%; height: 100%; object-fit: cover"
          />
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">
            <i class="bi bi-person-vcard-fill me-2"></i>
            Personal & Address Information
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="text-muted small">Birthday</label>
                <p class="mb-0">
                  <%= profile.personalData.dateOfBirth ? new
                  Date(profile.personalData.dateOfBirth).toLocaleDateString('en-US', { year:
                  'numeric', month: 'long', day: 'numeric' }) : 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Civil Status</label>
                <p class="mb-0">
                  <%= profile.personalData.civilStatus || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Gender</label>
                <p class="mb-0">
                  <%= profile.personalData.sex || 'Not set' %>
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="text-muted small">Home Address</label>
                <p class="mb-0">
                  <%= profile.personalData.homeAddress || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Current Address</label>
                <p class="mb-0">
                  <%= profile.personalData.currentAddress || 'Not set' %>
                </p>
              </div>
              <div class="mb-3">
                <label class="text-muted small">Parent/Guardian</label>
                <p class="mb-0">
                  <%= profile.personalData.guardianName || 'Not set' %>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
            </div>
        </div>
    </div>
</div>

<% if (typeof profile === 'undefined' || !profile) { %>
  <div class="alert alert-danger">
    Error: Student profile not found. Please contact an administrator.
  </div>
<% } else { %>
  <!-- ...existing profile display code... -->
<% } %>

<script>
document.querySelectorAll('.document-upload').forEach(input => {
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('docType', e.target.dataset.docType);

            const response = await fetch('/student/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Upload failed');
            }

            console.log('Upload successful:', result);
            window.location.reload();
        } catch (err) {
            console.error('Upload error:', err);
            alert(err.message || 'Upload failed. Please try again.');
        }
    });
});

function toggleComments(btn) {
  const commentsSection = btn.nextElementSibling;
  if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    btn.classList.add('active');
  } else {
    commentsSection.style.display = 'none';
    btn.classList.remove('active');
  }
}

// Update comment submission handler
document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = form.querySelector('input');
        const announcementId = form.dataset.announcement;
        
        if (!input.value.trim()) return;

        try {
            const response = await fetch(`/coordinator/announcement/${announcementId}/comment`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: input.value.trim() })
            });
            
            if (!response.ok) throw new Error('Failed to post comment');
            
            const comment = await response.json();
            
            // Add new comment to DOM
            const commentsList = form.nextElementSibling;
            const commentHtml = `
                <div class="d-flex gap-2 mb-2">
                    <img src="${comment.author.profilePicture || '/images/default-avatar.png'}" 
                         class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;">
                    <div class="bg-light rounded-3 p-2 flex-grow-1">
                        <div class="fw-bold">${comment.author.name || comment.author.email}</div>
                        <p class="mb-1">${comment.content}</p>
                        <small class="text-muted">${new Date(comment.createdAt).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</small>
                    </div>
                </div>
            `;
            commentsList.insertAdjacentHTML('afterbegin', commentHtml);
            
            // Update comment count
            const commentBtn = form.closest('.comments-section').previousElementSibling;
            const currentCount = parseInt(commentBtn.textContent.match(/\d+/)[0]);
            commentBtn.innerHTML = `<i class="bi bi-chat"></i> Comments (${currentCount + 1})`;
            
            input.value = '';
        } catch (err) {
            alert('Error posting comment: ' + err.message);
        }
    });
});
</script>
