<div class="d-flex">
    <!-- Left Navigation - Fixed Position -->
    <div class="sidebar bg-light border-end" style="width: 280px; height: 100vh; position: fixed; top: 0; left: 0; overflow-y: auto;">
        <div class="p-3 border-bottom">
            <div class="text-center mb-3">
                <!-- Replace profile section with logo -->
                <img src="/images/logo-placeholder.png" alt="Logo" style="width: 150px; height: auto;">
            </div>
        </div>
        <div class="nav flex-column nav-pills p-3">
            <a class="nav-link active" href="#home" data-bs-toggle="pill">
                <i class="bi bi-house-door"></i> Home
            </a>
            <a class="nav-link" href="#documents" data-bs-toggle="pill">
                <i class="bi bi-file-earmark-text"></i> Documents
            </a>
            <a class="nav-link" href="#profile" data-bs-toggle="pill">
                <i class="bi bi-person"></i> Profile
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); min-height: 100vh;">
        <div class="container py-4">
            <div class="tab-content">
                <!-- Home/Announcements Tab -->
                <div class="tab-pane fade show active" id="home">
                    <h4 class="mb-4">Announcements</h4>
                    <div class="announcements-list">
                        <% if (announcements && announcements.length > 0) { %>
                            <% announcements.forEach(announcement => { %>
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-2">
                                            <img src="<%= announcement.author.profilePicture || '/images/default-avatar.png' %>" 
                                                 class="rounded-circle me-2" 
                                                 style="width: 40px; height: 40px; object-fit: cover;">
                                            <div>
                                                <h5 class="card-title mb-0"><%= announcement.title %></h5>
                                                <small class="text-muted">Posted by <%= announcement.author.name || 'Coordinator' %></small>
                                            </div>
                                        </div>
                                        <p class="card-text"><%= announcement.content %></p>
                                        <small class="text-muted">
                                            Posted on <%= new Date(announcement.createdAt).toLocaleString() %>
                                        </small>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-muted">No announcements yet.</p>
                        <% } %>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div class="tab-pane fade" id="documents">
                    <h4 class="mb-4">Required Documents</h4>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        Upload your documents here for review. Your coordinator will label each file as Complied if approved or Needs Action if further updates are required. Use the download icons to get printable templates.
                    </div>
                    
                    <div class="accordion" id="documentsAccordion">
                        <!-- Pre-Deployment Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="preDeploymentHeader">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#preDeploymentCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Pre-Deployment Documents
                                    <% const preDeploymentCompleted = preDeploymentDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Done') // Changed from 'Completed' to 'Done'
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= preDeploymentCompleted %>/<%= preDeploymentDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (preDeploymentCompleted/preDeploymentDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="preDeploymentCollapse" class="accordion-collapse collapse show">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% preDeploymentDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments || '-' %></small>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Legal Forms Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="legalFormsHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#legalFormsCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Legal Forms
                                    <% const legalFormsCompleted = legalForms.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Completed')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= legalFormsCompleted %>/<%= legalForms.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (legalFormsCompleted/legalForms.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="legalFormsCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% legalForms.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments || '-' %></small>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Post-OJT Requirements Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="postOjtHeader">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#postOjtCollapse">
                                    <i class="bi bi-file-earmark-text me-2"></i>Post-OJT Requirements
                                    <% const postOjtCompleted = postOjtDocs.filter(doc => 
                                        profile.documents.find(d => d.docType === doc.value && d.status === 'Completed')
                                    ).length; %>
                                    <div class="ms-auto me-3">
                                        <small class="text-muted"><%= postOjtCompleted %>/<%= postOjtDocs.length %></small>
                                    </div>
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: <%= (postOjtCompleted/postOjtDocs.length * 100) %>%">
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="postOjtCollapse" class="accordion-collapse collapse">
                                <div class="accordion-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document</th>
                                                    <th style="width: 200px;">Upload Scan</th>
                                                    <th style="width: 150px;">Status</th>
                                                    <th>Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% postOjtDocs.forEach(doc => { 
                                                    const existingDoc = profile.documents.find(d => d.docType === doc.value);
                                                %>
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <a href="/student/templates/<%= doc.value %>" 
                                                               class="btn btn-sm btn-link text-decoration-none" 
                                                               title="Download Template">
                                                                <img src="/images/downloads.png" alt="Download" style="width: 20px; height: 20px;">
                                                            </a>
                                                            <%= doc.label %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <label class="btn btn-sm btn-outline-primary mb-0 me-2">
                                                                <i class="bi bi-upload"></i> Upload
                                                                <input type="file" 
                                                                       data-doc-type="<%= doc.value %>"
                                                                       style="display: none;"
                                                                       class="document-upload"
                                                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                                            </label>
                                                            <% if (existingDoc) { %>
                                                                <a href="<%= existingDoc.fileUrl %>" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                                    <i class="bi bi-eye"></i> View
                                                                </a>
                                                            <% } %>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="badge rounded-pill <%= existingDoc ? 
                                                            (existingDoc.status === 'Done' ? 'bg-success' : 
                                                             existingDoc.status === 'For Revision' ? 'bg-danger' : 
                                                             existingDoc.status === 'Checked' ? 'bg-warning' : 'bg-info') 
                                                            : 'bg-secondary' %>">
                                                            <%= existingDoc ? existingDoc.status : 'Not Submitted' %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted"><%= existingDoc?.comments || '-' %></small>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div class="tab-pane fade" id="profile">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <h4>Student Profile</h4>
                                <div class="text-center">
                                    <img src="<%= profile.personalData.profilePicture || '/images/default-avatar.png' %>" 
                                         class="rounded-circle profile-picture mb-2" 
                                         style="width: 150px; height: 150px; object-fit: cover;">
                                    <div>
                                        <a href="/student/edit-profile" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Edit Profile
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Student ID</label>
                                    <p class="mb-0"><%= profile.personalData.studentId %></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Full Name</label>
                                    <p class="mb-0">
                                        <%= profile.personalData.givenName %> <%= profile.personalData.middleName %> <%= profile.personalData.surname %>
                                    </p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Course</label>
                                    <p class="mb-0"><%= profile.personalData.course %></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Year & Section</label>
                                    <p class="mb-0"><%= profile.personalData.yearSection %></p>
                                </div>
                                <!-- Add other profile fields -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Contact Number</label>
                                    <p class="mb-0"><%= profile.personalData.contactNumber %></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted">Email</label>
                                    <p class="mb-0"><%= user.email %></p>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label text-muted">Current Address</label>
                                    <p class="mb-0"><%= profile.personalData.currentAddress %></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<% if (typeof profile === 'undefined' || !profile) { %>
  <div class="alert alert-danger">
    Error: Student profile not found. Please contact an administrator.
  </div>
<% } else { %>
  <!-- ...existing profile display code... -->
<% } %>

<script>
document.querySelectorAll('.document-upload').forEach(input => {
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('docType', e.target.dataset.docType);

            const response = await fetch('/student/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Upload failed');
            }

            console.log('Upload successful:', result);
            window.location.reload();
        } catch (err) {
            console.error('Upload error:', err);
            alert(err.message || 'Upload failed. Please try again.');
        }
    });
});
</script>
